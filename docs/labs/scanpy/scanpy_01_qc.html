<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Åsa Björklund &amp; Paulo Czarnewski">
<meta name="description" content="Quality control of single cell RNA-Seq data. Inspection of QC metrics including number of UMIs, number of genes expressed, mitochondrial and ribosomal expression, sex and cell cycle state.">

<title> Quality Control</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #E9F2D1;
      }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&amp;family=Nunito:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap" rel="stylesheet">
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/logos/nbis-scilifelab.png" alt="nbis-scilifelab-logo." class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../home_schedule.html" rel="" target="">
 <span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../home_contents.html" rel="" target="">
 <span class="menu-text">Contents</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../home_precourse.html" rel="" target="">
 <span class="menu-text">Precourse</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../home_syllabus.html" rel="" target="">
 <span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../home_info.html" rel="" target="">
 <span class="menu-text">Info</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title"><i class="fa-solid fa-clipboard-list" aria-label="clipboard-list"></i> Quality Control</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
            <p class="subtitle lead"><i class="fa-brands fa-python" aria-label="python"></i> SCANPY TOOLKIT</p>
                  <div>
        <div class="description">
          Quality control of single cell RNA-Seq data. Inspection of QC metrics including number of UMIs, number of genes expressed, mitochondrial and ribosomal expression, sex and cell cycle state.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Åsa Björklund &amp; Paulo Czarnewski </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">10-Nov-2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#meta-qc_data" id="toc-meta-qc_data" class="nav-link active" data-scroll-target="#meta-qc_data"><span class="header-section-number">1</span> Get data</a></li>
  <li><a href="#meta-qc_collate" id="toc-meta-qc_collate" class="nav-link" data-scroll-target="#meta-qc_collate"><span class="header-section-number">2</span> Collate</a></li>
  <li><a href="#meta-qc_calqc" id="toc-meta-qc_calqc" class="nav-link" data-scroll-target="#meta-qc_calqc"><span class="header-section-number">3</span> Calculate QC</a></li>
  <li><a href="#meta-qc_plotqc" id="toc-meta-qc_plotqc" class="nav-link" data-scroll-target="#meta-qc_plotqc"><span class="header-section-number">4</span> Plot QC</a></li>
  <li><a href="#meta-qc_filter" id="toc-meta-qc_filter" class="nav-link" data-scroll-target="#meta-qc_filter"><span class="header-section-number">5</span> Filtering</a>
  <ul>
  <li><a href="#meta-qc_filter_detect" id="toc-meta-qc_filter_detect" class="nav-link" data-scroll-target="#meta-qc_filter_detect"><span class="header-section-number">5.1</span> Detection-based filtering</a></li>
  <li><a href="#meta-qc_filter_mr" id="toc-meta-qc_filter_mr" class="nav-link" data-scroll-target="#meta-qc_filter_mr"><span class="header-section-number">5.2</span> Mito/Ribo filtering</a></li>
  <li><a href="#meta-qc_filter_plot" id="toc-meta-qc_filter_plot" class="nav-link" data-scroll-target="#meta-qc_filter_plot"><span class="header-section-number">5.3</span> Plot filtered QC</a></li>
  <li><a href="#meta-qc_filter_genes" id="toc-meta-qc_filter_genes" class="nav-link" data-scroll-target="#meta-qc_filter_genes"><span class="header-section-number">5.4</span> Filter genes</a></li>
  </ul></li>
  <li><a href="#meta-qc_sex" id="toc-meta-qc_sex" class="nav-link" data-scroll-target="#meta-qc_sex"><span class="header-section-number">6</span> Sample sex</a></li>
  <li><a href="#meta-qc_cellcycle" id="toc-meta-qc_cellcycle" class="nav-link" data-scroll-target="#meta-qc_cellcycle"><span class="header-section-number">7</span> Cell cycle state</a></li>
  <li><a href="#meta-qc_doublet" id="toc-meta-qc_doublet" class="nav-link" data-scroll-target="#meta-qc_doublet"><span class="header-section-number">8</span> Predict doublets</a></li>
  <li><a href="#meta-qc_save" id="toc-meta-qc_save" class="nav-link" data-scroll-target="#meta-qc_save"><span class="header-section-number">9</span> Save data</a></li>
  <li><a href="#meta-session" id="toc-meta-session" class="nav-link" data-scroll-target="#meta-session"><span class="header-section-number">10</span> Session info</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Code chunks run Python commands unless it starts with <code>%%bash</code>, in which case, those chunks run shell commands.</p>
</div>
</div>
<section id="meta-qc_data" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="meta-qc_data"><span class="header-section-number">1</span> Get data</h2>
<p>In this tutorial, we will run all tutorials with a set of 6 PBMC 10x datasets from 3 covid-19 patients and 3 healthy controls, the samples have been subsampled to 1500 cells per sample. They are part of the github repo and if you have cloned the repo they should be available in folder: <code>labs/data/covid_data_GSE149689</code>. Instructions on how to download them can also be found in the Precourse material.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">!</span> <span class="op">-</span>d <span class="st">"data/raw"</span> ] </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>then</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a data directory.</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  mkdir <span class="op">-</span>p data<span class="op">/</span>raw</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># first check if the files are there</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  count<span class="op">=</span>$(ls <span class="op">-</span>l data<span class="op">/</span>raw<span class="op">/*</span>.h5 <span class="op">|</span> grep <span class="op">-</span>v <span class="op">^</span>d <span class="op">|</span> wc <span class="op">-</span>l )</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  echo $count</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if not 4 files, fetch the files from github.</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((<span class="st">"$count"</span> <span class="op">&lt;</span>  <span class="dv">6</span>))<span class="op">;</span> then</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    cd data<span class="op">/</span>raw</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>Normal_PBMC_13.h5</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>Normal_PBMC_14.h5</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>Normal_PBMC_5.h5</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>nCoV_PBMC_15.h5</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>nCoV_PBMC_17.h5</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>nCoV_PBMC_1.h5</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    cd ..<span class="op">/</span>..</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  fi</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>fi</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>ls <span class="op">-</span>lGa data<span class="op">/</span>raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>total 22188
drwxr-xr-x  8 root         256 Oct  9 15:23 .
drwxr-xr-x 11 root         352 Nov  3 11:11 ..
-rw-r--r--  1 royfr474 3169573 Oct  9 15:23 nCoV_PBMC_15.h5
-rw-r--r--  1 royfr474 4105636 Oct  9 15:23 nCoV_PBMC_17.h5
-rw-r--r--  1 royfr474 3426598 Oct  9 15:23 nCoV_PBMC_1.h5
-rw-r--r--  1 royfr474 4391693 Oct  9 15:23 Normal_PBMC_13.h5
-rw-r--r--  1 royfr474 3806925 Oct  9 15:23 Normal_PBMC_14.h5
-rw-r--r--  1 royfr474 3806384 Oct  9 15:23 Normal_PBMC_5.h5</code></pre>
</div>
</div>
<p>With data in place, now we can start loading libraries we will use in this tutorial.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scanpy <span class="im">as</span> sc</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># verbosity: errors (0), warnings (1), info (2), hints (3)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>sc.settings.verbosity <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>sc.settings.set_figure_params(dpi<span class="op">=</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can first load the data individually by reading directly from HDF5 file format (.h5).</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data_cov1 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/nCoV_PBMC_1.h5'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data_cov1.var_names_make_unique()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>data_cov15 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/nCoV_PBMC_15.h5'</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>data_cov15.var_names_make_unique()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>data_cov17 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/nCoV_PBMC_17.h5'</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>data_cov17.var_names_make_unique()</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>data_ctrl5 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/Normal_PBMC_5.h5'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>data_ctrl5.var_names_make_unique()</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>data_ctrl13 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/Normal_PBMC_13.h5'</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>data_ctrl13.var_names_make_unique()</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>data_ctrl14 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/Normal_PBMC_14.h5'</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>data_ctrl14.var_names_make_unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="meta-qc_collate" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="meta-qc_collate"><span class="header-section-number">2</span> Collate</h2>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add some metadata</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>data_cov1.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Covid"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>data_cov1.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"covid_1"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>data_cov15.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Covid"</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>data_cov15.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"covid_15"</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>data_cov17.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Covid"</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>data_cov17.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"covid_17"</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>data_ctrl5.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Ctrl"</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>data_ctrl5.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"ctrl_5"</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>data_ctrl13.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Ctrl"</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>data_ctrl13.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"ctrl_13"</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>data_ctrl14.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Ctrl"</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>data_ctrl14.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"ctrl_14"</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># merge into one object.</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> data_cov1.concatenate(data_cov15, data_cov17, data_ctrl5, data_ctrl13, data_ctrl14)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># and delete individual datasets to save space</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(data_cov1, data_cov15, data_cov17)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(data_ctrl5, data_ctrl13, data_ctrl14)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can print a summary of the datasets in the Scanpy object, or a summary of the whole object.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'sample'</span>].value_counts())</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>adata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>covid_1     1500
covid_15    1500
covid_17    1500
ctrl_5      1500
ctrl_13     1500
ctrl_14     1500
Name: sample, dtype: int64</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>AnnData object with n_obs × n_vars = 9000 × 33538
    obs: 'type', 'sample', 'batch'
    var: 'gene_ids', 'feature_types', 'genome'</code></pre>
</div>
</div>
</section>
<section id="meta-qc_calqc" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="meta-qc_calqc"><span class="header-section-number">3</span> Calculate QC</h2>
<p>Having the data in a suitable format, we can start calculating some quality metrics. We can for example calculate the percentage of mitochondrial and ribosomal genes per cell and add to the metadata. The proportion hemoglobin genes can give an indication of red blood cell contamination. This will be helpful to visualize them across different metadata parameteres (i.e.&nbsp;datasetID and chemistry version). There are several ways of doing this. The QC metrics are finally added to the metadata table.</p>
<p>Citing from Simple Single Cell workflows (Lun, McCarthy &amp; Marioni, 2017): High proportions are indicative of poor-quality cells (Islam et al.&nbsp;2014; Ilicic et al.&nbsp;2016), possibly because of loss of cytoplasmic RNA from perforated cells. The reasoning is that mitochondria are larger than individual transcript molecules and less likely to escape through tears in the cell membrane.</p>
<p>First, let Scanpy calculate some general qc-stats for genes and cells with the function <code>sc.pp.calculate_qc_metrics</code>, similar to <code>calculateQCmetrics()</code> in Scater. It can also calculate proportion of counts for specific gene populations, so first we need to define which genes are mitochondrial, ribosomal and hemoglobin.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mitochondrial genes</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'mt'</span>] <span class="op">=</span> adata.var_names.<span class="bu">str</span>.startswith(<span class="st">'MT-'</span>) </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ribosomal genes</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'ribo'</span>] <span class="op">=</span> adata.var_names.<span class="bu">str</span>.startswith((<span class="st">"RPS"</span>,<span class="st">"RPL"</span>))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># hemoglobin genes.</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'hb'</span>] <span class="op">=</span> adata.var_names.<span class="bu">str</span>.contains((<span class="st">"^HB[^(P)]"</span>))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>adata.var</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">gene_ids</th>
<th data-quarto-table-cell-role="th">feature_types</th>
<th data-quarto-table-cell-role="th">genome</th>
<th data-quarto-table-cell-role="th">mt</th>
<th data-quarto-table-cell-role="th">ribo</th>
<th data-quarto-table-cell-role="th">hb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">MIR1302-2HG</td>
<td>ENSG00000243485</td>
<td>Gene Expression</td>
<td>GRCh38</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">FAM138A</td>
<td>ENSG00000237613</td>
<td>Gene Expression</td>
<td>GRCh38</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">OR4F5</td>
<td>ENSG00000186092</td>
<td>Gene Expression</td>
<td>GRCh38</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">AL627309.1</td>
<td>ENSG00000238009</td>
<td>Gene Expression</td>
<td>GRCh38</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">AL627309.3</td>
<td>ENSG00000239945</td>
<td>Gene Expression</td>
<td>GRCh38</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">AC233755.2</td>
<td>ENSG00000277856</td>
<td>Gene Expression</td>
<td>GRCh38</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">AC233755.1</td>
<td>ENSG00000275063</td>
<td>Gene Expression</td>
<td>GRCh38</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">AC240274.1</td>
<td>ENSG00000271254</td>
<td>Gene Expression</td>
<td>GRCh38</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">AC213203.1</td>
<td>ENSG00000277475</td>
<td>Gene Expression</td>
<td>GRCh38</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">FAM231C</td>
<td>ENSG00000268674</td>
<td>Gene Expression</td>
<td>GRCh38</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
</tbody>
</table>

<p>33538 rows × 6 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sc.pp.calculate_qc_metrics(adata, qc_vars<span class="op">=</span>[<span class="st">'mt'</span>,<span class="st">'ribo'</span>,<span class="st">'hb'</span>], percent_top<span class="op">=</span><span class="va">None</span>, log1p<span class="op">=</span><span class="va">False</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now you can see that we have additional data in the metadata slot.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>mito_genes <span class="op">=</span> adata.var_names.<span class="bu">str</span>.startswith(<span class="st">'MT-'</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for each cell compute fraction of counts in mito genes vs. all genes</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the `.A1` is only necessary as X is sparse (to transform to a dense array after summing)</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'percent_mt2'</span>] <span class="op">=</span> np.<span class="bu">sum</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    adata[:, mito_genes].X, axis<span class="op">=</span><span class="dv">1</span>).A1 <span class="op">/</span> np.<span class="bu">sum</span>(adata.X, axis<span class="op">=</span><span class="dv">1</span>).A1</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># add the total counts per cell as observations-annotation to adata</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'n_counts'</span>] <span class="op">=</span> adata.X.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>).A1</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>adata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>AnnData object with n_obs × n_vars = 9000 × 33538
    obs: 'type', 'sample', 'batch', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'total_counts_ribo', 'pct_counts_ribo', 'total_counts_hb', 'pct_counts_hb', 'percent_mt2', 'n_counts'
    var: 'gene_ids', 'feature_types', 'genome', 'mt', 'ribo', 'hb', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts'</code></pre>
</div>
</div>
</section>
<section id="meta-qc_plotqc" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="meta-qc_plotqc"><span class="header-section-number">4</span> Plot QC</h2>
<p>Now we can plot some of the QC variables as violin plots.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">'n_genes_by_counts'</span>, <span class="st">'total_counts'</span>, <span class="st">'pct_counts_mt'</span>,<span class="st">'pct_counts_ribo'</span>, <span class="st">'pct_counts_hb'</span>], jitter<span class="op">=</span><span class="fl">0.4</span>, groupby <span class="op">=</span> <span class="st">'sample'</span>, rotation<span class="op">=</span> <span class="dv">45</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><a href="scanpy_01_qc_files/figure-html/cell-10-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="scanpy_01_qc_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>As you can see, there is quite some difference in quality for the 4 datasets, with for instance the covid_15 sample having fewer cells with many detected genes and more mitochondrial content. As the ribosomal proteins are highly expressed they will make up a larger proportion of the transcriptional landscape when fewer of the lowly expressed genes are detected. And we can plot the different QC-measures as scatter plots.</p>
<div class="cell" data-fig-height="5" data-fig-width="5" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>sc.pl.scatter(adata, x<span class="op">=</span><span class="st">'total_counts'</span>, y<span class="op">=</span><span class="st">'pct_counts_mt'</span>, color<span class="op">=</span><span class="st">"sample"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><a href="scanpy_01_qc_files/figure-html/cell-11-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="scanpy_01_qc_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Discuss">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Discuss
</div>
</div>
<div class="callout-body-container callout-body">
<p>Plot additional QC stats that we have calculated as scatter plots. How are the different measures correlated? Can you explain why?</p>
</div>
</div>
</section>
<section id="meta-qc_filter" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="meta-qc_filter"><span class="header-section-number">5</span> Filtering</h2>
<section id="meta-qc_filter_detect" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="meta-qc_filter_detect"><span class="header-section-number">5.1</span> Detection-based filtering</h3>
<p>A standard approach is to filter cells with low amount of reads as well as genes that are present in at least a certain amount of cells. Here we will only consider cells with at least 200 detected genes and genes need to be expressed in at least 3 cells. Please note that those values are highly dependent on the library preparation method used.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>sc.pp.filter_cells(adata, min_genes<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>sc.pp.filter_genes(adata, min_cells<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.n_obs, adata.n_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7979 18778</code></pre>
</div>
</div>
<p>Extremely high number of detected genes could indicate doublets. However, depending on the cell type composition in your sample, you may have cells with higher number of genes (and also higher counts) from one cell type. In this case, we will run doublet prediction further down, so we will skip this step now, but the code below is an example of how it can be run:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># skip for now as we are doing doublet prediction</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#keep_v2 = (adata.obs['n_genes_by_counts'] &lt; 2000) &amp; (adata.obs['n_genes_by_counts'] &gt; 500) &amp; (adata.obs['lib_prep'] == 'v2')</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#print(sum(keep_v2))</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># filter for gene detection for v3</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">#keep_v3 = (adata.obs['n_genes_by_counts'] &lt; 4100) &amp; (adata.obs['n_genes_by_counts'] &gt; 1000) &amp; (adata.obs['lib_prep'] != 'v2')</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">#print(sum(keep_v3))</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># keep both sets of cells</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">#keep = (keep_v2) | (keep_v3)</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">#print(sum(keep))</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">#adata = adata[keep, :]</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">#print("Remaining cells %d"%adata.n_obs)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Additionally, we can also see which genes contribute the most to such reads. We can for instance plot the percentage of counts per gene.</p>
<div class="cell" data-fig-height="6" data-fig-width="6" data-execution_count="13">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>sc.pl.highest_expr_genes(adata, n_top<span class="op">=</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><a href="scanpy_01_qc_files/figure-html/cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="scanpy_01_qc_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>As you can see, MALAT1 constitutes up to 30% of the UMIs from a single cell and the other top genes are mitochondrial and ribosomal genes. It is quite common that nuclear lincRNAs have correlation with quality and mitochondrial reads, so high detection of MALAT1 may be a technical issue. Let us assemble some information about such genes, which are important for quality control and downstream filtering.</p>
</section>
<section id="meta-qc_filter_mr" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="meta-qc_filter_mr"><span class="header-section-number">5.2</span> Mito/Ribo filtering</h3>
<p>We also have quite a lot of cells with high proportion of mitochondrial and low proportion of ribosomal reads. It could be wise to remove those cells, if we have enough cells left after filtering. Another option would be to either remove all mitochondrial reads from the dataset and hope that the remaining genes still have enough biological signal. A third option would be to just regress out the <code>percent_mito</code> variable during scaling. In this case we had as much as 99.7% mitochondrial reads in some of the cells, so it is quite unlikely that there is much cell type signature left in those. Looking at the plots, make reasonable decisions on where to draw the cutoff. In this case, the bulk of the cells are below 20% mitochondrial reads and that will be used as a cutoff. We will also remove cells with less than 5% ribosomal reads.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter for percent mito</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[adata.obs[<span class="st">'pct_counts_mt'</span>] <span class="op">&lt;</span> <span class="dv">20</span>, :]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># filter for percent ribo &gt; 0.05</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[adata.obs[<span class="st">'pct_counts_ribo'</span>] <span class="op">&gt;</span> <span class="dv">5</span>, :]</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Remaining cells </span><span class="sc">%d</span><span class="st">"</span><span class="op">%</span>adata.n_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Remaining cells 5762</code></pre>
</div>
</div>
<p>As you can see, a large proportion of sample covid_15 is filtered out. Also, there is still quite a lot of variation in <code>percent_mito</code>, so it will have to be dealt with in the data analysis step. We can also notice that the <code>percent_ribo</code> are also highly variable, but that is expected since different cell types have different proportions of ribosomal content, according to their function.</p>
</section>
<section id="meta-qc_filter_plot" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="meta-qc_filter_plot"><span class="header-section-number">5.3</span> Plot filtered QC</h3>
<p>Lets plot the same QC-stats another time.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">'n_genes_by_counts'</span>, <span class="st">'total_counts'</span>, <span class="st">'pct_counts_mt'</span>,<span class="st">'pct_counts_ribo'</span>, <span class="st">'pct_counts_hb'</span>], jitter<span class="op">=</span><span class="fl">0.4</span>, groupby <span class="op">=</span> <span class="st">'sample'</span>, rotation <span class="op">=</span> <span class="dv">45</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><a href="scanpy_01_qc_files/figure-html/cell-16-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="scanpy_01_qc_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="meta-qc_filter_genes" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="meta-qc_filter_genes"><span class="header-section-number">5.4</span> Filter genes</h3>
<p>As the level of expression of mitochondrial and MALAT1 genes are judged as mainly technical, it can be wise to remove them from the dataset before any further analysis.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>malat1 <span class="op">=</span> adata.var_names.<span class="bu">str</span>.startswith(<span class="st">'MALAT1'</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to redefine the mito_genes since they were first </span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># calculated on the full object before removing low expressed genes.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>mito_genes <span class="op">=</span> adata.var_names.<span class="bu">str</span>.startswith(<span class="st">'MT-'</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>hb_genes <span class="op">=</span> adata.var_names.<span class="bu">str</span>.contains(<span class="st">'^HB[^(P)]'</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>remove <span class="op">=</span> np.add(mito_genes, malat1)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>remove <span class="op">=</span> np.add(remove, hb_genes)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>keep <span class="op">=</span> np.invert(remove)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[:,keep]</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.n_obs, adata.n_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5762 18752</code></pre>
</div>
</div>
</section>
</section>
<section id="meta-qc_sex" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="meta-qc_sex"><span class="header-section-number">6</span> Sample sex</h2>
<p>When working with human or animal samples, you should ideally constrain you experiments to a single sex to avoid including sex bias in the conclusions. However this may not always be possible. By looking at reads from chromosomeY (males) and XIST (X-inactive specific transcript) expression (mainly female) it is quite easy to determine per sample which sex it is. It can also bee a good way to detect if there has been any sample mixups, if the sample metadata sex does not agree with the computational predictions.</p>
<p>To get choromosome information for all genes, you should ideally parse the information from the gtf file that you used in the mapping pipeline as it has the exact same annotation version/gene naming. However, it may not always be available, as in this case where we have downloaded public data. Hence, we will use biomart to fetch chromosome information.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># requires pybiomart</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>annot <span class="op">=</span> sc.queries.biomart_annotations(<span class="st">"hsapiens"</span>, [<span class="st">"ensembl_gene_id"</span>, <span class="st">"external_gene_name"</span>, <span class="st">"start_position"</span>, <span class="st">"end_position"</span>, <span class="st">"chromosome_name"</span>], ).set_index(<span class="st">"external_gene_name"</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># adata.var[annot.columns] = annot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have the chromosome information, we can calculate per cell the proportion of reads that comes from chromosome Y.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>chrY_genes <span class="op">=</span> adata.var_names.intersection(annot.index[annot.chromosome_name <span class="op">==</span> <span class="st">"Y"</span>])</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>chrY_genes</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'percent_chrY'</span>] <span class="op">=</span> np.<span class="bu">sum</span>(</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    adata[:, chrY_genes].X, axis<span class="op">=</span><span class="dv">1</span>).A1 <span class="op">/</span> np.<span class="bu">sum</span>(adata.X, axis<span class="op">=</span><span class="dv">1</span>).A1 <span class="op">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then plot XIST expression vs chrY proportion. As you can see, the samples are clearly on either side, even if some cells do not have detection of either.</p>
<div class="cell" data-fig-height="5" data-fig-width="5" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># color inputs must be from either .obs or .var, so add in XIST expression to obs.</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">"XIST-counts"</span>] <span class="op">=</span> adata.X[:,adata.var_names.<span class="bu">str</span>.match(<span class="st">'XIST'</span>)].toarray()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>sc.pl.scatter(adata, x<span class="op">=</span><span class="st">'XIST-counts'</span>, y<span class="op">=</span><span class="st">'percent_chrY'</span>, color<span class="op">=</span><span class="st">"sample"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><a href="scanpy_01_qc_files/figure-html/cell-20-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="scanpy_01_qc_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Plot as violins.</p>
<div class="cell" data-fig-height="5" data-fig-width="10" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">"XIST-counts"</span>, <span class="st">"percent_chrY"</span>], jitter<span class="op">=</span><span class="fl">0.4</span>, groupby <span class="op">=</span> <span class="st">'sample'</span>, rotation<span class="op">=</span> <span class="dv">45</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><a href="scanpy_01_qc_files/figure-html/cell-21-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="scanpy_01_qc_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Here, we can see clearly that we have two males and 4 females, can you see which samples they are? Do you think this will cause any problems for downstream analysis? Discuss with your group: what would be the best way to deal with this type of sex bias?</p>
</section>
<section id="meta-qc_cellcycle" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="meta-qc_cellcycle"><span class="header-section-number">7</span> Cell cycle state</h2>
<p>We here perform cell cycle scoring. To score a gene list, the algorithm calculates the difference of mean expression of the given list and the mean expression of reference genes. To build the reference, the function randomly chooses a bunch of genes matching the distribution of the expression of the given list. Cell cycle scoring adds three slots in data, a score for S phase, a score for G2M phase and the predicted cell cycle phase.</p>
<p>First read the file with cell cycle genes, from Regev lab and split into S and G2M phase genes. Cell cycle genes were retrieved from the scanpy_usage github site via web browser at <a href="https://github.com/theislab/scanpy_usage/blob/master/180209_cell_cycle/data/regev_lab_cell_cycle_genes.txt">RegevLab Github repo</a>.</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">!</span> <span class="op">-</span>f data<span class="op">/</span>regev_lab_cell_cycle_genes.txt ]<span class="op">;</span> then curl <span class="op">-</span>o data<span class="op">/</span>regev_lab_cell_cycle_genes.txt https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>theislab<span class="op">/</span>scanpy_usage<span class="op">/</span>master<span class="op">/</span><span class="dv">180209</span><span class="er">_cell_cycle</span><span class="op">/</span>data<span class="op">/</span>regev_lab_cell_cycle_genes.txt<span class="op">;</span> fi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>cell_cycle_genes <span class="op">=</span> [x.strip() <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">open</span>(<span class="st">'./data/regev_lab_cell_cycle_genes.txt'</span>)]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(cell_cycle_genes))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Split into 2 lists</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>s_genes <span class="op">=</span> cell_cycle_genes[:<span class="dv">43</span>]</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>g2m_genes <span class="op">=</span> cell_cycle_genes[<span class="dv">43</span>:]</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>cell_cycle_genes <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> cell_cycle_genes <span class="cf">if</span> x <span class="kw">in</span> adata.var_names]</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(cell_cycle_genes))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>97
94</code></pre>
</div>
</div>
<p>Before running cell cycle we have to normalize the data. In the scanpy object, the data slot will be overwritten with the normalized data. So first, save the raw data into the slot <code>raw</code>. Then run normalization, log transformation and scale the data.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save normalized counts in raw slot.</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>adata.raw <span class="op">=</span> adata</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># normalize to depth 10 000</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>sc.pp.normalize_per_cell(adata, counts_per_cell_after<span class="op">=</span><span class="fl">1e4</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># logaritmize</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>sc.pp.log1p(adata)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># scale</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>sc.pp.scale(adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We here perform cell cycle scoring. The function is actually a wrapper to sc.tl.score_gene_list, which is launched twice, to score separately S and G2M phases. Both sc.tl.score_gene_list and sc.tl.score_cell_cycle_genes are a port from Seurat and are supposed to work in a very similar way. To score a gene list, the algorithm calculates the difference of mean expression of the given list and the mean expression of reference genes. To build the reference, the function randomly chooses a bunch of genes matching the distribution of the expression of the given list. Cell cycle scoring adds three slots in data, a score for S phase, a score for G2M phase and the predicted cell cycle phase.</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>sc.tl.score_genes_cell_cycle(adata, s_genes<span class="op">=</span>s_genes, g2m_genes<span class="op">=</span>g2m_genes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now plot a violin plot for the cell cycle scores as well.</p>
<div class="cell" data-fig-height="5" data-fig-width="10" data-execution_count="25">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">'S_score'</span>, <span class="st">'G2M_score'</span>], jitter<span class="op">=</span><span class="fl">0.4</span>, groupby <span class="op">=</span> <span class="st">'sample'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><a href="scanpy_01_qc_files/figure-html/cell-26-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="scanpy_01_qc_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>In this case it looks like we only have a few cycling cells in the datasets.</p>
</section>
<section id="meta-qc_doublet" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="meta-qc_doublet"><span class="header-section-number">8</span> Predict doublets</h2>
<p>Doublets/Multiples of cells in the same well/droplet is a common issue in scRNAseq protocols. Especially in droplet-based methods with overloading of cells. In a typical 10x experiment the proportion of doublets is linearly dependent on the amount of loaded cells. As indicated from the Chromium user guide, doublet rates are about as follows:<br>
<a href="../figs/10x_doublet_rate.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="../figs/10x_doublet_rate.png" class="img-fluid"></a><br>
Most doublet detectors simulates doublets by merging cell counts and predicts doublets as cells that have similar embeddings as the simulated doublets. Most such packages need an assumption about the number/proportion of expected doublets in the dataset. The data you are using is subsampled, but the original datasets contained about 5 000 cells per sample, hence we can assume that they loaded about 9 000 cells and should have a doublet rate at about 4%.</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ideally doublet prediction should be run on each sample separately, especially if your different samples have different proportions of cell types. In this case, the data is subsampled so we have very few cells per sample and all samples are sorted PBMCs so it is okay to run them together.</p>
</div>
</div>
<p>For doublet detection, we will use the package <code>Scrublet</code>, so first we need to get the raw counts from <code>adata.raw.X</code> and run scrublet with that matrix. Then we add in the doublet prediction info into our anndata object.</p>
<p>Doublet prediction should be run for each dataset separately, so first we need to split the adata object into 6 separate objects, one per sample and then run scrublet on each of them.</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scrublet <span class="im">as</span> scr</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># split per batch into new objects.</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>batches <span class="op">=</span> adata.obs[<span class="st">'sample'</span>].cat.categories.tolist()</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>alldata <span class="op">=</span> {}</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch <span class="kw">in</span> batches:</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> adata[adata.obs[<span class="st">'sample'</span>] <span class="op">==</span> batch,]</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(batch, <span class="st">":"</span>, tmp.shape[<span class="dv">0</span>], <span class="st">" cells"</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    scrub <span class="op">=</span> scr.Scrublet(tmp.raw.X)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> scrub.scrub_doublets(verbose<span class="op">=</span><span class="va">False</span>, n_prin_comps <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    alldata[batch] <span class="op">=</span> pd.DataFrame({<span class="st">'doublet_score'</span>:out[<span class="dv">0</span>],<span class="st">'predicted_doublets'</span>:out[<span class="dv">1</span>]},index <span class="op">=</span> tmp.obs.index)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(alldata[batch].predicted_doublets.<span class="bu">sum</span>(), <span class="st">" predicted_doublets"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>covid_1 : 878  cells
34  predicted_doublets
covid_15 : 585  cells
2  predicted_doublets
covid_17 : 1042  cells
24  predicted_doublets
ctrl_5 : 1040  cells
12  predicted_doublets
ctrl_13 : 1154  cells
22  predicted_doublets
ctrl_14 : 1063  cells
22  predicted_doublets</code></pre>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add predictions to the adata object.</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>scrub_pred <span class="op">=</span> pd.concat(alldata.values())</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'doublet_scores'</span>] <span class="op">=</span> scrub_pred[<span class="st">'doublet_score'</span>] </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'predicted_doublets'</span>] <span class="op">=</span> scrub_pred[<span class="st">'predicted_doublets'</span>] </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>(adata.obs[<span class="st">'predicted_doublets'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>116</code></pre>
</div>
</div>
<p>We should expect that two cells have more detected genes than a single cell, lets check if our predicted doublets also have more detected genes in general.</p>
<div class="cell" data-fig-height="5" data-fig-width="5" data-execution_count="28">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add in column with singlet/doublet instead of True/Fals</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'doublet_info'</span>] <span class="op">=</span> adata.obs[<span class="st">"predicted_doublets"</span>].astype(<span class="bu">str</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, <span class="st">'n_genes_by_counts'</span>, jitter<span class="op">=</span><span class="fl">0.4</span>, groupby <span class="op">=</span> <span class="st">'doublet_info'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><a href="scanpy_01_qc_files/figure-html/cell-29-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="scanpy_01_qc_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Now, lets run PCA and UMAP and plot doublet scores onto UMAP to check the doublet predictions.</p>
<div class="cell" data-fig-height="4" data-fig-width="12" data-execution_count="29">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>sc.pp.highly_variable_genes(adata, min_mean<span class="op">=</span><span class="fl">0.0125</span>, max_mean<span class="op">=</span><span class="dv">3</span>, min_disp<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[:, adata.var.highly_variable]</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>sc.pp.regress_out(adata, [<span class="st">'total_counts'</span>, <span class="st">'pct_counts_mt'</span>])</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>sc.pp.scale(adata, max_value<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>sc.tl.pca(adata, svd_solver<span class="op">=</span><span class="st">'arpack'</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata, n_neighbors<span class="op">=</span><span class="dv">10</span>, n_pcs<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(adata)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span>[<span class="st">'doublet_scores'</span>,<span class="st">'doublet_info'</span>,<span class="st">'sample'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><a href="scanpy_01_qc_files/figure-html/cell-30-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="scanpy_01_qc_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Now, lets remove all predicted doublets from our data.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># also revert back to the raw counts as the main matrix in adata</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata.raw.to_adata() </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[adata.obs[<span class="st">'doublet_info'</span>] <span class="op">==</span> <span class="st">'False'</span>,:]</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(5646, 18752)</code></pre>
</div>
</div>
</section>
<section id="meta-qc_save" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="meta-qc_save"><span class="header-section-number">9</span> Save data</h2>
<p>Finally, lets save the QC-filtered data for further analysis. Create output directory <code>results</code> and save data to that folder. This will be used in downstream labs.</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'data/results/'</span>):</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    os.makedirs(<span class="st">'data/results/'</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'data/results/scanpy_qc_filtered_covid.h5ad'</span>):</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    adata.write_h5ad(<span class="st">'data/results/scanpy_qc_filtered_covid.h5ad'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="meta-session" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="meta-session"><span class="header-section-number">10</span> Session info</h2>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>sc.logging.print_versions()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-----
anndata     0.9.2
scanpy      1.7.2
sinfo       0.3.1
-----
PIL                         10.0.0
anndata                     0.9.2
annoy                       NA
anyio                       NA
arrow                       1.3.0
asttokens                   NA
attr                        23.1.0
attrs                       23.1.0
babel                       2.12.1
backcall                    0.2.0
brotli                      1.0.9
certifi                     2023.07.22
cffi                        1.16.0
charset_normalizer          3.2.0
colorama                    0.4.6
comm                        0.1.4
cpuinfo                     NA
cycler                      0.10.0
cython_runtime              NA
dateutil                    2.8.2
debugpy                     1.8.0
decorator                   5.1.1
defusedxml                  0.7.1
dunamai                     1.18.0
exceptiongroup              1.1.3
executing                   1.2.0
fastjsonschema              NA
fqdn                        NA
future                      0.18.3
get_version                 3.5.4
h5py                        3.9.0
idna                        3.4
igraph                      0.11.2
importlib_resources         NA
ipykernel                   6.25.2
ipywidgets                  8.1.1
isoduration                 NA
jedi                        0.19.1
jinja2                      3.1.2
joblib                      1.3.0
json5                       NA
jsonpointer                 2.4
jsonschema                  4.19.1
jsonschema_specifications   NA
jupyter_events              0.7.0
jupyter_server              2.7.3
jupyterlab_server           2.25.0
kiwisolver                  1.4.5
lazy_loader                 NA
legacy_api_wrap             0.0.0
leidenalg                   0.10.1
llvmlite                    0.40.1
louvain                     0.8.1
markupsafe                  2.1.3
matplotlib                  3.6.3
matplotlib_inline           0.1.6
mpl_toolkits                NA
natsort                     8.4.0
nbformat                    5.9.2
numba                       0.57.1
numexpr                     2.8.4
numpy                       1.24.4
overrides                   NA
packaging                   23.1
pandas                      1.5.3
parso                       0.8.3
patsy                       0.5.3
pexpect                     4.8.0
pickleshare                 0.7.5
pkg_resources               NA
platformdirs                3.10.0
pooch                       v1.7.0
prometheus_client           NA
prompt_toolkit              3.0.39
psutil                      5.9.5
ptyprocess                  0.7.0
pure_eval                   0.2.2
pybiomart                   0.2.0
pycparser                   2.21
pydev_ipython               NA
pydevconsole                NA
pydevd                      2.9.5
pydevd_file_utils           NA
pydevd_plugins              NA
pydevd_tracing              NA
pygments                    2.16.1
pynndescent                 0.5.10
pyparsing                   3.0.9
pythonjsonlogger            NA
pytz                        2023.3
referencing                 NA
requests                    2.31.0
requests_cache              0.4.13
rfc3339_validator           0.1.4
rfc3986_validator           0.1.1
rpds                        NA
scanpy                      1.7.2
scipy                       1.10.1
scrublet                    NA
seaborn                     0.12.2
send2trash                  NA
setuptools_scm              NA
sinfo                       0.3.1
six                         1.16.0
skimage                     0.21.0
sklearn                     1.3.1
sniffio                     1.3.0
socks                       1.7.1
stack_data                  0.6.2
statsmodels                 0.14.0
tables                      3.8.0
texttable                   1.7.0
threadpoolctl               3.2.0
tornado                     6.3.3
tqdm                        4.65.0
traitlets                   5.11.2
typing_extensions           NA
umap                        0.5.4
uri_template                NA
urllib3                     2.0.4
wcwidth                     0.2.8
webcolors                   1.13
websocket                   1.6.4
yaml                        6.0.1
zipp                        NA
zmq                         25.1.1
-----
IPython             8.12.2
jupyter_client      8.3.1
jupyter_core        5.4.0
jupyterlab          4.0.6
notebook            7.0.4
-----
Python 3.8.18 | packaged by conda-forge | (default, Oct 10 2023, 15:44:36) [GCC 12.3.0]
Linux-6.4.16-linuxkit-x86_64-with-glibc2.10
11 logical CPU cores, x86_64
-----
Session information updated at 2023-11-10 19:05
</code></pre>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb45" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "{{&lt; meta qc_title &gt;}}"</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "{{&lt; meta subtitle_scanpy &gt;}}"</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "{{&lt; meta qc_description &gt;}}"</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> jupyter</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>Code chunks run Python commands unless it starts with <span class="in">`%%bash`</span>, in which case, those chunks run shell commands.</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## {{&lt; meta qc_data &gt;}}</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_data_1 &gt;}}</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">!</span> <span class="op">-</span>d <span class="st">"data/raw"</span> ] </span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>then</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a data directory.</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>  mkdir <span class="op">-</span>p data<span class="op">/</span>raw</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># first check if the files are there</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>  count<span class="op">=</span>$(ls <span class="op">-</span>l data<span class="op">/</span>raw<span class="op">/*</span>.h5 <span class="op">|</span> grep <span class="op">-</span>v <span class="op">^</span>d <span class="op">|</span> wc <span class="op">-</span>l )</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>  echo $count</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if not 4 files, fetch the files from github.</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((<span class="st">"$count"</span> <span class="op">&lt;</span>  <span class="dv">6</span>))<span class="op">;</span> then</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>    cd data<span class="op">/</span>raw</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>Normal_PBMC_13.h5</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>Normal_PBMC_14.h5</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>Normal_PBMC_5.h5</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>nCoV_PBMC_15.h5</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>nCoV_PBMC_17.h5</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>    curl <span class="op">-</span>O https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>NBISweden<span class="op">/</span>workshop<span class="op">-</span>scRNAseq<span class="op">/</span>new_dataset<span class="op">/</span>labs<span class="op">/</span>data<span class="op">/</span>covid_data_GSE149689<span class="op">/</span>sub<span class="op">/</span>nCoV_PBMC_1.h5</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>    cd ..<span class="op">/</span>..</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>  fi</span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>fi</span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>ls <span class="op">-</span>lGa data<span class="op">/</span>raw</span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_data_2 &gt;}}</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scanpy <span class="im">as</span> sc</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a><span class="co"># verbosity: errors (0), warnings (1), info (2), hints (3)</span></span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>sc.settings.verbosity <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>sc.settings.set_figure_params(dpi<span class="op">=</span><span class="dv">80</span>)</span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_data_3 &gt;}}</span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a>data_cov1 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/nCoV_PBMC_1.h5'</span>)</span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a>data_cov1.var_names_make_unique()</span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>data_cov15 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/nCoV_PBMC_15.h5'</span>)</span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>data_cov15.var_names_make_unique()</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>data_cov17 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/nCoV_PBMC_17.h5'</span>)</span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>data_cov17.var_names_make_unique()</span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>data_ctrl5 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/Normal_PBMC_5.h5'</span>)</span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>data_ctrl5.var_names_make_unique()</span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a>data_ctrl13 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/Normal_PBMC_13.h5'</span>)</span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a>data_ctrl13.var_names_make_unique()</span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a>data_ctrl14 <span class="op">=</span> sc.read_10x_h5(<span class="st">'./data/raw/Normal_PBMC_14.h5'</span>)</span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a>data_ctrl14.var_names_make_unique()</span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a><span class="fu">## {{&lt; meta qc_collate &gt;}}</span></span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a><span class="co"># add some metadata</span></span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a>data_cov1.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Covid"</span></span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a>data_cov1.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"covid_1"</span></span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a>data_cov15.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Covid"</span></span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a>data_cov15.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"covid_15"</span></span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a>data_cov17.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Covid"</span></span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a>data_cov17.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"covid_17"</span></span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a>data_ctrl5.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Ctrl"</span></span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a>data_ctrl5.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"ctrl_5"</span></span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a>data_ctrl13.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Ctrl"</span></span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a>data_ctrl13.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"ctrl_13"</span></span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a>data_ctrl14.obs[<span class="st">'type'</span>]<span class="op">=</span><span class="st">"Ctrl"</span></span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a>data_ctrl14.obs[<span class="st">'sample'</span>]<span class="op">=</span><span class="st">"ctrl_14"</span></span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a><span class="co"># merge into one object.</span></span>
<span id="cb45-101"><a href="#cb45-101" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> data_cov1.concatenate(data_cov15, data_cov17, data_ctrl5, data_ctrl13, data_ctrl14)</span>
<span id="cb45-102"><a href="#cb45-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-103"><a href="#cb45-103" aria-hidden="true" tabindex="-1"></a><span class="co"># and delete individual datasets to save space</span></span>
<span id="cb45-104"><a href="#cb45-104" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(data_cov1, data_cov15, data_cov17)</span>
<span id="cb45-105"><a href="#cb45-105" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(data_ctrl5, data_ctrl13, data_ctrl14)</span>
<span id="cb45-106"><a href="#cb45-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-107"><a href="#cb45-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-108"><a href="#cb45-108" aria-hidden="true" tabindex="-1"></a>You can print a summary of the datasets in the Scanpy object, or a summary of the whole object.</span>
<span id="cb45-109"><a href="#cb45-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-112"><a href="#cb45-112" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-113"><a href="#cb45-113" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.obs[<span class="st">'sample'</span>].value_counts())</span>
<span id="cb45-114"><a href="#cb45-114" aria-hidden="true" tabindex="-1"></a>adata</span>
<span id="cb45-115"><a href="#cb45-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-116"><a href="#cb45-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-117"><a href="#cb45-117" aria-hidden="true" tabindex="-1"></a><span class="fu">## {{&lt; meta qc_calqc &gt;}}</span></span>
<span id="cb45-118"><a href="#cb45-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-119"><a href="#cb45-119" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_calqc_1 &gt;}}</span>
<span id="cb45-120"><a href="#cb45-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-121"><a href="#cb45-121" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_calqc_2 &gt;}}</span>
<span id="cb45-122"><a href="#cb45-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-123"><a href="#cb45-123" aria-hidden="true" tabindex="-1"></a>First, let Scanpy calculate some general qc-stats for genes and cells with the function <span class="in">`sc.pp.calculate_qc_metrics`</span>, similar to <span class="in">`calculateQCmetrics()`</span> in Scater. It can also calculate proportion of counts for specific gene populations, so first we need to define which genes are mitochondrial, ribosomal and hemoglobin.</span>
<span id="cb45-124"><a href="#cb45-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-127"><a href="#cb45-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-128"><a href="#cb45-128" aria-hidden="true" tabindex="-1"></a><span class="co"># mitochondrial genes</span></span>
<span id="cb45-129"><a href="#cb45-129" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'mt'</span>] <span class="op">=</span> adata.var_names.<span class="bu">str</span>.startswith(<span class="st">'MT-'</span>) </span>
<span id="cb45-130"><a href="#cb45-130" aria-hidden="true" tabindex="-1"></a><span class="co"># ribosomal genes</span></span>
<span id="cb45-131"><a href="#cb45-131" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'ribo'</span>] <span class="op">=</span> adata.var_names.<span class="bu">str</span>.startswith((<span class="st">"RPS"</span>,<span class="st">"RPL"</span>))</span>
<span id="cb45-132"><a href="#cb45-132" aria-hidden="true" tabindex="-1"></a><span class="co"># hemoglobin genes.</span></span>
<span id="cb45-133"><a href="#cb45-133" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'hb'</span>] <span class="op">=</span> adata.var_names.<span class="bu">str</span>.contains((<span class="st">"^HB[^(P)]"</span>))</span>
<span id="cb45-134"><a href="#cb45-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-135"><a href="#cb45-135" aria-hidden="true" tabindex="-1"></a>adata.var</span>
<span id="cb45-136"><a href="#cb45-136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-137"><a href="#cb45-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-140"><a href="#cb45-140" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-141"><a href="#cb45-141" aria-hidden="true" tabindex="-1"></a>sc.pp.calculate_qc_metrics(adata, qc_vars<span class="op">=</span>[<span class="st">'mt'</span>,<span class="st">'ribo'</span>,<span class="st">'hb'</span>], percent_top<span class="op">=</span><span class="va">None</span>, log1p<span class="op">=</span><span class="va">False</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb45-142"><a href="#cb45-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-143"><a href="#cb45-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-144"><a href="#cb45-144" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_calqc_3 &gt;}}</span>
<span id="cb45-145"><a href="#cb45-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-148"><a href="#cb45-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-149"><a href="#cb45-149" aria-hidden="true" tabindex="-1"></a>mito_genes <span class="op">=</span> adata.var_names.<span class="bu">str</span>.startswith(<span class="st">'MT-'</span>)</span>
<span id="cb45-150"><a href="#cb45-150" aria-hidden="true" tabindex="-1"></a><span class="co"># for each cell compute fraction of counts in mito genes vs. all genes</span></span>
<span id="cb45-151"><a href="#cb45-151" aria-hidden="true" tabindex="-1"></a><span class="co"># the `.A1` is only necessary as X is sparse (to transform to a dense array after summing)</span></span>
<span id="cb45-152"><a href="#cb45-152" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'percent_mt2'</span>] <span class="op">=</span> np.<span class="bu">sum</span>(</span>
<span id="cb45-153"><a href="#cb45-153" aria-hidden="true" tabindex="-1"></a>    adata[:, mito_genes].X, axis<span class="op">=</span><span class="dv">1</span>).A1 <span class="op">/</span> np.<span class="bu">sum</span>(adata.X, axis<span class="op">=</span><span class="dv">1</span>).A1</span>
<span id="cb45-154"><a href="#cb45-154" aria-hidden="true" tabindex="-1"></a><span class="co"># add the total counts per cell as observations-annotation to adata</span></span>
<span id="cb45-155"><a href="#cb45-155" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'n_counts'</span>] <span class="op">=</span> adata.X.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>).A1</span>
<span id="cb45-156"><a href="#cb45-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-157"><a href="#cb45-157" aria-hidden="true" tabindex="-1"></a>adata</span>
<span id="cb45-158"><a href="#cb45-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-159"><a href="#cb45-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-160"><a href="#cb45-160" aria-hidden="true" tabindex="-1"></a><span class="fu">## {{&lt; meta qc_plotqc &gt;}}</span></span>
<span id="cb45-161"><a href="#cb45-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-162"><a href="#cb45-162" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_plotqc_1 &gt;}}</span>
<span id="cb45-163"><a href="#cb45-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-166"><a href="#cb45-166" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-167"><a href="#cb45-167" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">'n_genes_by_counts'</span>, <span class="st">'total_counts'</span>, <span class="st">'pct_counts_mt'</span>,<span class="st">'pct_counts_ribo'</span>, <span class="st">'pct_counts_hb'</span>], jitter<span class="op">=</span><span class="fl">0.4</span>, groupby <span class="op">=</span> <span class="st">'sample'</span>, rotation<span class="op">=</span> <span class="dv">45</span>)</span>
<span id="cb45-168"><a href="#cb45-168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-169"><a href="#cb45-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-170"><a href="#cb45-170" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_plotqc_2 &gt;}}</span>
<span id="cb45-171"><a href="#cb45-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-174"><a href="#cb45-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-175"><a href="#cb45-175" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb45-176"><a href="#cb45-176" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb45-177"><a href="#cb45-177" aria-hidden="true" tabindex="-1"></a>sc.pl.scatter(adata, x<span class="op">=</span><span class="st">'total_counts'</span>, y<span class="op">=</span><span class="st">'pct_counts_mt'</span>, color<span class="op">=</span><span class="st">"sample"</span>)</span>
<span id="cb45-178"><a href="#cb45-178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-179"><a href="#cb45-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-180"><a href="#cb45-180" aria-hidden="true" tabindex="-1"></a>:::{.callout-note title="Discuss"}</span>
<span id="cb45-181"><a href="#cb45-181" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_plotqc_3 &gt;}}</span>
<span id="cb45-182"><a href="#cb45-182" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb45-183"><a href="#cb45-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-184"><a href="#cb45-184" aria-hidden="true" tabindex="-1"></a><span class="fu">## {{&lt; meta qc_filter &gt;}}</span></span>
<span id="cb45-185"><a href="#cb45-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-186"><a href="#cb45-186" aria-hidden="true" tabindex="-1"></a><span class="fu">### {{&lt; meta qc_filter_detect &gt;}}</span></span>
<span id="cb45-187"><a href="#cb45-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-188"><a href="#cb45-188" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_filter_detect_1 &gt;}}</span>
<span id="cb45-189"><a href="#cb45-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-192"><a href="#cb45-192" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-193"><a href="#cb45-193" aria-hidden="true" tabindex="-1"></a>sc.pp.filter_cells(adata, min_genes<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb45-194"><a href="#cb45-194" aria-hidden="true" tabindex="-1"></a>sc.pp.filter_genes(adata, min_cells<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb45-195"><a href="#cb45-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-196"><a href="#cb45-196" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.n_obs, adata.n_vars)</span>
<span id="cb45-197"><a href="#cb45-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-198"><a href="#cb45-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-199"><a href="#cb45-199" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_filter_detect_3 &gt;}}</span>
<span id="cb45-200"><a href="#cb45-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-203"><a href="#cb45-203" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-204"><a href="#cb45-204" aria-hidden="true" tabindex="-1"></a><span class="co"># skip for now as we are doing doublet prediction</span></span>
<span id="cb45-205"><a href="#cb45-205" aria-hidden="true" tabindex="-1"></a><span class="co">#keep_v2 = (adata.obs['n_genes_by_counts'] &lt; 2000) &amp; (adata.obs['n_genes_by_counts'] &gt; 500) &amp; (adata.obs['lib_prep'] == 'v2')</span></span>
<span id="cb45-206"><a href="#cb45-206" aria-hidden="true" tabindex="-1"></a><span class="co">#print(sum(keep_v2))</span></span>
<span id="cb45-207"><a href="#cb45-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-208"><a href="#cb45-208" aria-hidden="true" tabindex="-1"></a><span class="co"># filter for gene detection for v3</span></span>
<span id="cb45-209"><a href="#cb45-209" aria-hidden="true" tabindex="-1"></a><span class="co">#keep_v3 = (adata.obs['n_genes_by_counts'] &lt; 4100) &amp; (adata.obs['n_genes_by_counts'] &gt; 1000) &amp; (adata.obs['lib_prep'] != 'v2')</span></span>
<span id="cb45-210"><a href="#cb45-210" aria-hidden="true" tabindex="-1"></a><span class="co">#print(sum(keep_v3))</span></span>
<span id="cb45-211"><a href="#cb45-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-212"><a href="#cb45-212" aria-hidden="true" tabindex="-1"></a><span class="co"># keep both sets of cells</span></span>
<span id="cb45-213"><a href="#cb45-213" aria-hidden="true" tabindex="-1"></a><span class="co">#keep = (keep_v2) | (keep_v3)</span></span>
<span id="cb45-214"><a href="#cb45-214" aria-hidden="true" tabindex="-1"></a><span class="co">#print(sum(keep))</span></span>
<span id="cb45-215"><a href="#cb45-215" aria-hidden="true" tabindex="-1"></a><span class="co">#adata = adata[keep, :]</span></span>
<span id="cb45-216"><a href="#cb45-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-217"><a href="#cb45-217" aria-hidden="true" tabindex="-1"></a><span class="co">#print("Remaining cells %d"%adata.n_obs)</span></span>
<span id="cb45-218"><a href="#cb45-218" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-219"><a href="#cb45-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-220"><a href="#cb45-220" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_filter_detect_4 &gt;}}</span>
<span id="cb45-221"><a href="#cb45-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-224"><a href="#cb45-224" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-225"><a href="#cb45-225" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 6</span></span>
<span id="cb45-226"><a href="#cb45-226" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 6</span></span>
<span id="cb45-227"><a href="#cb45-227" aria-hidden="true" tabindex="-1"></a>sc.pl.highest_expr_genes(adata, n_top<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb45-228"><a href="#cb45-228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-229"><a href="#cb45-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-230"><a href="#cb45-230" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_filter_detect_5 &gt;}}</span>
<span id="cb45-231"><a href="#cb45-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-232"><a href="#cb45-232" aria-hidden="true" tabindex="-1"></a><span class="fu">### {{&lt; meta qc_filter_mr &gt;}}</span></span>
<span id="cb45-233"><a href="#cb45-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-234"><a href="#cb45-234" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_filter_mr_1 &gt;}}</span>
<span id="cb45-235"><a href="#cb45-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-238"><a href="#cb45-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-239"><a href="#cb45-239" aria-hidden="true" tabindex="-1"></a><span class="co"># filter for percent mito</span></span>
<span id="cb45-240"><a href="#cb45-240" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[adata.obs[<span class="st">'pct_counts_mt'</span>] <span class="op">&lt;</span> <span class="dv">20</span>, :]</span>
<span id="cb45-241"><a href="#cb45-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-242"><a href="#cb45-242" aria-hidden="true" tabindex="-1"></a><span class="co"># filter for percent ribo &gt; 0.05</span></span>
<span id="cb45-243"><a href="#cb45-243" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[adata.obs[<span class="st">'pct_counts_ribo'</span>] <span class="op">&gt;</span> <span class="dv">5</span>, :]</span>
<span id="cb45-244"><a href="#cb45-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-245"><a href="#cb45-245" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Remaining cells </span><span class="sc">%d</span><span class="st">"</span><span class="op">%</span>adata.n_obs)</span>
<span id="cb45-246"><a href="#cb45-246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-247"><a href="#cb45-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-248"><a href="#cb45-248" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_filter_mr_2 &gt;}}</span>
<span id="cb45-249"><a href="#cb45-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-250"><a href="#cb45-250" aria-hidden="true" tabindex="-1"></a><span class="fu">### {{&lt; meta qc_filter_plot &gt;}}</span></span>
<span id="cb45-251"><a href="#cb45-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-252"><a href="#cb45-252" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_filter_plot_1 &gt;}}</span>
<span id="cb45-253"><a href="#cb45-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-256"><a href="#cb45-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-257"><a href="#cb45-257" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">'n_genes_by_counts'</span>, <span class="st">'total_counts'</span>, <span class="st">'pct_counts_mt'</span>,<span class="st">'pct_counts_ribo'</span>, <span class="st">'pct_counts_hb'</span>], jitter<span class="op">=</span><span class="fl">0.4</span>, groupby <span class="op">=</span> <span class="st">'sample'</span>, rotation <span class="op">=</span> <span class="dv">45</span>)</span>
<span id="cb45-258"><a href="#cb45-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-259"><a href="#cb45-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-260"><a href="#cb45-260" aria-hidden="true" tabindex="-1"></a><span class="fu">### {{&lt; meta qc_filter_genes &gt;}}</span></span>
<span id="cb45-261"><a href="#cb45-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-262"><a href="#cb45-262" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_filter_genes_1 &gt;}}</span>
<span id="cb45-263"><a href="#cb45-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-266"><a href="#cb45-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-267"><a href="#cb45-267" aria-hidden="true" tabindex="-1"></a>malat1 <span class="op">=</span> adata.var_names.<span class="bu">str</span>.startswith(<span class="st">'MALAT1'</span>)</span>
<span id="cb45-268"><a href="#cb45-268" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to redefine the mito_genes since they were first </span></span>
<span id="cb45-269"><a href="#cb45-269" aria-hidden="true" tabindex="-1"></a><span class="co"># calculated on the full object before removing low expressed genes.</span></span>
<span id="cb45-270"><a href="#cb45-270" aria-hidden="true" tabindex="-1"></a>mito_genes <span class="op">=</span> adata.var_names.<span class="bu">str</span>.startswith(<span class="st">'MT-'</span>)</span>
<span id="cb45-271"><a href="#cb45-271" aria-hidden="true" tabindex="-1"></a>hb_genes <span class="op">=</span> adata.var_names.<span class="bu">str</span>.contains(<span class="st">'^HB[^(P)]'</span>)</span>
<span id="cb45-272"><a href="#cb45-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-273"><a href="#cb45-273" aria-hidden="true" tabindex="-1"></a>remove <span class="op">=</span> np.add(mito_genes, malat1)</span>
<span id="cb45-274"><a href="#cb45-274" aria-hidden="true" tabindex="-1"></a>remove <span class="op">=</span> np.add(remove, hb_genes)</span>
<span id="cb45-275"><a href="#cb45-275" aria-hidden="true" tabindex="-1"></a>keep <span class="op">=</span> np.invert(remove)</span>
<span id="cb45-276"><a href="#cb45-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-277"><a href="#cb45-277" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[:,keep]</span>
<span id="cb45-278"><a href="#cb45-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-279"><a href="#cb45-279" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.n_obs, adata.n_vars)</span>
<span id="cb45-280"><a href="#cb45-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-281"><a href="#cb45-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-282"><a href="#cb45-282" aria-hidden="true" tabindex="-1"></a><span class="fu">## {{&lt; meta qc_sex &gt;}}</span></span>
<span id="cb45-283"><a href="#cb45-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-284"><a href="#cb45-284" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_sex_1 &gt;}}</span>
<span id="cb45-285"><a href="#cb45-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-286"><a href="#cb45-286" aria-hidden="true" tabindex="-1"></a>To get choromosome information for all genes, you should ideally parse the information from the gtf file that you used in the mapping pipeline</span>
<span id="cb45-287"><a href="#cb45-287" aria-hidden="true" tabindex="-1"></a>as it has the exact same annotation version/gene naming. However, it may not always be available, as in this case where we have downloaded public data. Hence, we will use biomart to fetch chromosome information.</span>
<span id="cb45-288"><a href="#cb45-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-291"><a href="#cb45-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-292"><a href="#cb45-292" aria-hidden="true" tabindex="-1"></a><span class="co"># requires pybiomart</span></span>
<span id="cb45-293"><a href="#cb45-293" aria-hidden="true" tabindex="-1"></a>annot <span class="op">=</span> sc.queries.biomart_annotations(<span class="st">"hsapiens"</span>, [<span class="st">"ensembl_gene_id"</span>, <span class="st">"external_gene_name"</span>, <span class="st">"start_position"</span>, <span class="st">"end_position"</span>, <span class="st">"chromosome_name"</span>], ).set_index(<span class="st">"external_gene_name"</span>)</span>
<span id="cb45-294"><a href="#cb45-294" aria-hidden="true" tabindex="-1"></a><span class="co"># adata.var[annot.columns] = annot</span></span>
<span id="cb45-295"><a href="#cb45-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-296"><a href="#cb45-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-297"><a href="#cb45-297" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_sex_3 &gt;}}</span>
<span id="cb45-298"><a href="#cb45-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-301"><a href="#cb45-301" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-302"><a href="#cb45-302" aria-hidden="true" tabindex="-1"></a>chrY_genes <span class="op">=</span> adata.var_names.intersection(annot.index[annot.chromosome_name <span class="op">==</span> <span class="st">"Y"</span>])</span>
<span id="cb45-303"><a href="#cb45-303" aria-hidden="true" tabindex="-1"></a>chrY_genes</span>
<span id="cb45-304"><a href="#cb45-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-305"><a href="#cb45-305" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'percent_chrY'</span>] <span class="op">=</span> np.<span class="bu">sum</span>(</span>
<span id="cb45-306"><a href="#cb45-306" aria-hidden="true" tabindex="-1"></a>    adata[:, chrY_genes].X, axis<span class="op">=</span><span class="dv">1</span>).A1 <span class="op">/</span> np.<span class="bu">sum</span>(adata.X, axis<span class="op">=</span><span class="dv">1</span>).A1 <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb45-307"><a href="#cb45-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-308"><a href="#cb45-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-309"><a href="#cb45-309" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_sex_4 &gt;}}</span>
<span id="cb45-310"><a href="#cb45-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-313"><a href="#cb45-313" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-314"><a href="#cb45-314" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb45-315"><a href="#cb45-315" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb45-316"><a href="#cb45-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-317"><a href="#cb45-317" aria-hidden="true" tabindex="-1"></a><span class="co"># color inputs must be from either .obs or .var, so add in XIST expression to obs.</span></span>
<span id="cb45-318"><a href="#cb45-318" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">"XIST-counts"</span>] <span class="op">=</span> adata.X[:,adata.var_names.<span class="bu">str</span>.match(<span class="st">'XIST'</span>)].toarray()</span>
<span id="cb45-319"><a href="#cb45-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-320"><a href="#cb45-320" aria-hidden="true" tabindex="-1"></a>sc.pl.scatter(adata, x<span class="op">=</span><span class="st">'XIST-counts'</span>, y<span class="op">=</span><span class="st">'percent_chrY'</span>, color<span class="op">=</span><span class="st">"sample"</span>)</span>
<span id="cb45-321"><a href="#cb45-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-322"><a href="#cb45-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-323"><a href="#cb45-323" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_sex_5 &gt;}}</span>
<span id="cb45-324"><a href="#cb45-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-327"><a href="#cb45-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-328"><a href="#cb45-328" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb45-329"><a href="#cb45-329" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb45-330"><a href="#cb45-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-331"><a href="#cb45-331" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">"XIST-counts"</span>, <span class="st">"percent_chrY"</span>], jitter<span class="op">=</span><span class="fl">0.4</span>, groupby <span class="op">=</span> <span class="st">'sample'</span>, rotation<span class="op">=</span> <span class="dv">45</span>)</span>
<span id="cb45-332"><a href="#cb45-332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-333"><a href="#cb45-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-334"><a href="#cb45-334" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_sex_6 &gt;}}</span>
<span id="cb45-335"><a href="#cb45-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-336"><a href="#cb45-336" aria-hidden="true" tabindex="-1"></a><span class="fu">## {{&lt; meta qc_cellcycle &gt;}}</span></span>
<span id="cb45-337"><a href="#cb45-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-338"><a href="#cb45-338" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_cellcycle_1 &gt;}}</span>
<span id="cb45-339"><a href="#cb45-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-340"><a href="#cb45-340" aria-hidden="true" tabindex="-1"></a>First read the file with cell cycle genes, from Regev lab and split into S and G2M phase genes. Cell cycle genes were retrieved from the scanpy_usage github site via web browser at <span class="co">[</span><span class="ot">RegevLab Github repo</span><span class="co">](https://github.com/theislab/scanpy_usage/blob/master/180209_cell_cycle/data/regev_lab_cell_cycle_genes.txt)</span>.</span>
<span id="cb45-341"><a href="#cb45-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-344"><a href="#cb45-344" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-345"><a href="#cb45-345" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb45-346"><a href="#cb45-346" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ <span class="op">!</span> <span class="op">-</span>f data<span class="op">/</span>regev_lab_cell_cycle_genes.txt ]<span class="op">;</span> then curl <span class="op">-</span>o data<span class="op">/</span>regev_lab_cell_cycle_genes.txt https:<span class="op">//</span>raw.githubusercontent.com<span class="op">/</span>theislab<span class="op">/</span>scanpy_usage<span class="op">/</span>master<span class="op">/</span><span class="dv">180209</span><span class="er">_cell_cycle</span><span class="op">/</span>data<span class="op">/</span>regev_lab_cell_cycle_genes.txt<span class="op">;</span> fi</span>
<span id="cb45-347"><a href="#cb45-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-348"><a href="#cb45-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-351"><a href="#cb45-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-352"><a href="#cb45-352" aria-hidden="true" tabindex="-1"></a>cell_cycle_genes <span class="op">=</span> [x.strip() <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">open</span>(<span class="st">'./data/regev_lab_cell_cycle_genes.txt'</span>)]</span>
<span id="cb45-353"><a href="#cb45-353" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(cell_cycle_genes))</span>
<span id="cb45-354"><a href="#cb45-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-355"><a href="#cb45-355" aria-hidden="true" tabindex="-1"></a><span class="co"># Split into 2 lists</span></span>
<span id="cb45-356"><a href="#cb45-356" aria-hidden="true" tabindex="-1"></a>s_genes <span class="op">=</span> cell_cycle_genes[:<span class="dv">43</span>]</span>
<span id="cb45-357"><a href="#cb45-357" aria-hidden="true" tabindex="-1"></a>g2m_genes <span class="op">=</span> cell_cycle_genes[<span class="dv">43</span>:]</span>
<span id="cb45-358"><a href="#cb45-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-359"><a href="#cb45-359" aria-hidden="true" tabindex="-1"></a>cell_cycle_genes <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> cell_cycle_genes <span class="cf">if</span> x <span class="kw">in</span> adata.var_names]</span>
<span id="cb45-360"><a href="#cb45-360" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(cell_cycle_genes))</span>
<span id="cb45-361"><a href="#cb45-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-362"><a href="#cb45-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-363"><a href="#cb45-363" aria-hidden="true" tabindex="-1"></a>Before running cell cycle we have to normalize the data. In the scanpy object, the data slot will be overwritten with the normalized data. So first, save the raw data into the slot <span class="in">`raw`</span>. Then run normalization, log transformation and scale the data.</span>
<span id="cb45-364"><a href="#cb45-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-367"><a href="#cb45-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-368"><a href="#cb45-368" aria-hidden="true" tabindex="-1"></a><span class="co"># save normalized counts in raw slot.</span></span>
<span id="cb45-369"><a href="#cb45-369" aria-hidden="true" tabindex="-1"></a>adata.raw <span class="op">=</span> adata</span>
<span id="cb45-370"><a href="#cb45-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-371"><a href="#cb45-371" aria-hidden="true" tabindex="-1"></a><span class="co"># normalize to depth 10 000</span></span>
<span id="cb45-372"><a href="#cb45-372" aria-hidden="true" tabindex="-1"></a>sc.pp.normalize_per_cell(adata, counts_per_cell_after<span class="op">=</span><span class="fl">1e4</span>)</span>
<span id="cb45-373"><a href="#cb45-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-374"><a href="#cb45-374" aria-hidden="true" tabindex="-1"></a><span class="co"># logaritmize</span></span>
<span id="cb45-375"><a href="#cb45-375" aria-hidden="true" tabindex="-1"></a>sc.pp.log1p(adata)</span>
<span id="cb45-376"><a href="#cb45-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-377"><a href="#cb45-377" aria-hidden="true" tabindex="-1"></a><span class="co"># scale</span></span>
<span id="cb45-378"><a href="#cb45-378" aria-hidden="true" tabindex="-1"></a>sc.pp.scale(adata)</span>
<span id="cb45-379"><a href="#cb45-379" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-380"><a href="#cb45-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-381"><a href="#cb45-381" aria-hidden="true" tabindex="-1"></a>We here perform cell cycle scoring. The function is actually a wrapper to sc.tl.score_gene_list, which is launched twice, to score separately S and G2M phases. Both sc.tl.score_gene_list and sc.tl.score_cell_cycle_genes are a port from Seurat and are supposed to work in a very similar way. To score a gene list, the algorithm calculates the difference of mean expression of the given list and the mean expression of reference genes. To build the reference, the function randomly chooses a bunch of genes matching the distribution of the expression of the given list. Cell cycle scoring adds three slots in data, a score for S phase, a score for G2M phase and the predicted cell cycle phase.</span>
<span id="cb45-382"><a href="#cb45-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-385"><a href="#cb45-385" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-386"><a href="#cb45-386" aria-hidden="true" tabindex="-1"></a>sc.tl.score_genes_cell_cycle(adata, s_genes<span class="op">=</span>s_genes, g2m_genes<span class="op">=</span>g2m_genes)</span>
<span id="cb45-387"><a href="#cb45-387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-388"><a href="#cb45-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-389"><a href="#cb45-389" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_cellcycle_2 &gt;}}</span>
<span id="cb45-390"><a href="#cb45-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-393"><a href="#cb45-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-394"><a href="#cb45-394" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb45-395"><a href="#cb45-395" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb45-396"><a href="#cb45-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-397"><a href="#cb45-397" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, [<span class="st">'S_score'</span>, <span class="st">'G2M_score'</span>], jitter<span class="op">=</span><span class="fl">0.4</span>, groupby <span class="op">=</span> <span class="st">'sample'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb45-398"><a href="#cb45-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-399"><a href="#cb45-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-400"><a href="#cb45-400" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_cellcycle_3 &gt;}}</span>
<span id="cb45-401"><a href="#cb45-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-402"><a href="#cb45-402" aria-hidden="true" tabindex="-1"></a><span class="fu">## {{&lt; meta qc_doublet &gt;}}</span></span>
<span id="cb45-403"><a href="#cb45-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-404"><a href="#cb45-404" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_doublet_1 &gt;}}</span>
<span id="cb45-405"><a href="#cb45-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-406"><a href="#cb45-406" aria-hidden="true" tabindex="-1"></a>:::{.callout-caution}</span>
<span id="cb45-407"><a href="#cb45-407" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_doublet_2 &gt;}}</span>
<span id="cb45-408"><a href="#cb45-408" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb45-409"><a href="#cb45-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-410"><a href="#cb45-410" aria-hidden="true" tabindex="-1"></a>For doublet detection, we will use the package <span class="in">`Scrublet`</span>, so first we need to get the raw counts from <span class="in">`adata.raw.X`</span> and run scrublet with that matrix. Then we add in the doublet prediction info into our anndata object.</span>
<span id="cb45-411"><a href="#cb45-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-412"><a href="#cb45-412" aria-hidden="true" tabindex="-1"></a>Doublet prediction should be run for each dataset separately, so first we need to split the adata object into 6 separate objects, one per sample and then run scrublet on each of them.</span>
<span id="cb45-413"><a href="#cb45-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-416"><a href="#cb45-416" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-417"><a href="#cb45-417" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scrublet <span class="im">as</span> scr</span>
<span id="cb45-418"><a href="#cb45-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-419"><a href="#cb45-419" aria-hidden="true" tabindex="-1"></a><span class="co"># split per batch into new objects.</span></span>
<span id="cb45-420"><a href="#cb45-420" aria-hidden="true" tabindex="-1"></a>batches <span class="op">=</span> adata.obs[<span class="st">'sample'</span>].cat.categories.tolist()</span>
<span id="cb45-421"><a href="#cb45-421" aria-hidden="true" tabindex="-1"></a>alldata <span class="op">=</span> {}</span>
<span id="cb45-422"><a href="#cb45-422" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch <span class="kw">in</span> batches:</span>
<span id="cb45-423"><a href="#cb45-423" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> adata[adata.obs[<span class="st">'sample'</span>] <span class="op">==</span> batch,]</span>
<span id="cb45-424"><a href="#cb45-424" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(batch, <span class="st">":"</span>, tmp.shape[<span class="dv">0</span>], <span class="st">" cells"</span>)</span>
<span id="cb45-425"><a href="#cb45-425" aria-hidden="true" tabindex="-1"></a>    scrub <span class="op">=</span> scr.Scrublet(tmp.raw.X)</span>
<span id="cb45-426"><a href="#cb45-426" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> scrub.scrub_doublets(verbose<span class="op">=</span><span class="va">False</span>, n_prin_comps <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb45-427"><a href="#cb45-427" aria-hidden="true" tabindex="-1"></a>    alldata[batch] <span class="op">=</span> pd.DataFrame({<span class="st">'doublet_score'</span>:out[<span class="dv">0</span>],<span class="st">'predicted_doublets'</span>:out[<span class="dv">1</span>]},index <span class="op">=</span> tmp.obs.index)</span>
<span id="cb45-428"><a href="#cb45-428" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(alldata[batch].predicted_doublets.<span class="bu">sum</span>(), <span class="st">" predicted_doublets"</span>)</span>
<span id="cb45-429"><a href="#cb45-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-430"><a href="#cb45-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-433"><a href="#cb45-433" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-434"><a href="#cb45-434" aria-hidden="true" tabindex="-1"></a><span class="co"># add predictions to the adata object.</span></span>
<span id="cb45-435"><a href="#cb45-435" aria-hidden="true" tabindex="-1"></a>scrub_pred <span class="op">=</span> pd.concat(alldata.values())</span>
<span id="cb45-436"><a href="#cb45-436" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'doublet_scores'</span>] <span class="op">=</span> scrub_pred[<span class="st">'doublet_score'</span>] </span>
<span id="cb45-437"><a href="#cb45-437" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'predicted_doublets'</span>] <span class="op">=</span> scrub_pred[<span class="st">'predicted_doublets'</span>] </span>
<span id="cb45-438"><a href="#cb45-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-439"><a href="#cb45-439" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>(adata.obs[<span class="st">'predicted_doublets'</span>])</span>
<span id="cb45-440"><a href="#cb45-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-441"><a href="#cb45-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-442"><a href="#cb45-442" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_doublet_3 &gt;}}</span>
<span id="cb45-443"><a href="#cb45-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-446"><a href="#cb45-446" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-447"><a href="#cb45-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb45-448"><a href="#cb45-448" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5</span></span>
<span id="cb45-449"><a href="#cb45-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-450"><a href="#cb45-450" aria-hidden="true" tabindex="-1"></a><span class="co"># add in column with singlet/doublet instead of True/Fals</span></span>
<span id="cb45-451"><a href="#cb45-451" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb45-452"><a href="#cb45-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-453"><a href="#cb45-453" aria-hidden="true" tabindex="-1"></a>adata.obs[<span class="st">'doublet_info'</span>] <span class="op">=</span> adata.obs[<span class="st">"predicted_doublets"</span>].astype(<span class="bu">str</span>)</span>
<span id="cb45-454"><a href="#cb45-454" aria-hidden="true" tabindex="-1"></a>sc.pl.violin(adata, <span class="st">'n_genes_by_counts'</span>, jitter<span class="op">=</span><span class="fl">0.4</span>, groupby <span class="op">=</span> <span class="st">'doublet_info'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb45-455"><a href="#cb45-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-456"><a href="#cb45-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-457"><a href="#cb45-457" aria-hidden="true" tabindex="-1"></a>Now, lets run PCA and UMAP and plot doublet scores onto UMAP to check the doublet predictions.</span>
<span id="cb45-458"><a href="#cb45-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-461"><a href="#cb45-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-462"><a href="#cb45-462" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb45-463"><a href="#cb45-463" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb45-464"><a href="#cb45-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-465"><a href="#cb45-465" aria-hidden="true" tabindex="-1"></a>sc.pp.highly_variable_genes(adata, min_mean<span class="op">=</span><span class="fl">0.0125</span>, max_mean<span class="op">=</span><span class="dv">3</span>, min_disp<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb45-466"><a href="#cb45-466" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[:, adata.var.highly_variable]</span>
<span id="cb45-467"><a href="#cb45-467" aria-hidden="true" tabindex="-1"></a>sc.pp.regress_out(adata, [<span class="st">'total_counts'</span>, <span class="st">'pct_counts_mt'</span>])</span>
<span id="cb45-468"><a href="#cb45-468" aria-hidden="true" tabindex="-1"></a>sc.pp.scale(adata, max_value<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb45-469"><a href="#cb45-469" aria-hidden="true" tabindex="-1"></a>sc.tl.pca(adata, svd_solver<span class="op">=</span><span class="st">'arpack'</span>)</span>
<span id="cb45-470"><a href="#cb45-470" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata, n_neighbors<span class="op">=</span><span class="dv">10</span>, n_pcs<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb45-471"><a href="#cb45-471" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(adata)</span>
<span id="cb45-472"><a href="#cb45-472" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span>[<span class="st">'doublet_scores'</span>,<span class="st">'doublet_info'</span>,<span class="st">'sample'</span>])</span>
<span id="cb45-473"><a href="#cb45-473" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-474"><a href="#cb45-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-475"><a href="#cb45-475" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_doublet_4 &gt;}}</span>
<span id="cb45-476"><a href="#cb45-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-479"><a href="#cb45-479" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-480"><a href="#cb45-480" aria-hidden="true" tabindex="-1"></a><span class="co"># also revert back to the raw counts as the main matrix in adata</span></span>
<span id="cb45-481"><a href="#cb45-481" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata.raw.to_adata() </span>
<span id="cb45-482"><a href="#cb45-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-483"><a href="#cb45-483" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata[adata.obs[<span class="st">'doublet_info'</span>] <span class="op">==</span> <span class="st">'False'</span>,:]</span>
<span id="cb45-484"><a href="#cb45-484" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adata.shape)</span>
<span id="cb45-485"><a href="#cb45-485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-486"><a href="#cb45-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-487"><a href="#cb45-487" aria-hidden="true" tabindex="-1"></a><span class="fu">## {{&lt; meta qc_save &gt;}}</span></span>
<span id="cb45-488"><a href="#cb45-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-489"><a href="#cb45-489" aria-hidden="true" tabindex="-1"></a>{{&lt; meta qc_save_1 &gt;}}</span>
<span id="cb45-490"><a href="#cb45-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-493"><a href="#cb45-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-494"><a href="#cb45-494" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb45-495"><a href="#cb45-495" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'data/results/'</span>):</span>
<span id="cb45-496"><a href="#cb45-496" aria-hidden="true" tabindex="-1"></a>    os.makedirs(<span class="st">'data/results/'</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb45-497"><a href="#cb45-497" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'data/results/scanpy_qc_filtered_covid.h5ad'</span>):</span>
<span id="cb45-498"><a href="#cb45-498" aria-hidden="true" tabindex="-1"></a>    adata.write_h5ad(<span class="st">'data/results/scanpy_qc_filtered_covid.h5ad'</span>)</span>
<span id="cb45-499"><a href="#cb45-499" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb45-500"><a href="#cb45-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-501"><a href="#cb45-501" aria-hidden="true" tabindex="-1"></a><span class="fu">## {{&lt; meta session &gt;}}</span></span>
<span id="cb45-502"><a href="#cb45-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-505"><a href="#cb45-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb45-506"><a href="#cb45-506" aria-hidden="true" tabindex="-1"></a>sc.logging.print_versions()</span>
<span id="cb45-507"><a href="#cb45-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">2023 <a href="https://nbis.se">NBIS</a> | <a href="https://choosealicense.com/licenses/gpl-3.0/">GPL-3 License</a></div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Published with <a href="https://quarto.org/">Quarto</a> v1.3.433</div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"selector":".lightbox","closeEffect":"zoom","descPosition":"bottom","openEffect":"zoom","loop":true});</script>



<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>