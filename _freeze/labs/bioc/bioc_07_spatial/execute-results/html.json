{
  "hash": "8114874031c880879b67577effa9610a",
  "result": {
    "markdown": "---\ntitle: \"{{< meta st_title >}}\"\nsubtitle: \"{{< meta subtitle_bioc >}}\"\ndescription: \"{{< meta st_description >}}\"\nformat: html\n---\n\n\n::: {.callout-note}\nCode chunks run R commands unless otherwise specified.\n:::\n\n\n{{< meta st_1 >}}\n\n\n\n## {{< meta st_prep >}}\n\n\n{{< meta st_prep_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# BiocManager::install('DropletUtils',update = F)\n# BiocManager::install(\"Spaniel\",update = F)\n# remotes::install_github(\"RachelQueen1/Spaniel\", ref = \"Development\" ,upgrade = F,dependencies = F)\n# remotes::install_github(\"renozao/xbioc\")\n# remotes::install_github(\"meichendong/SCDC\")\n\nsuppressPackageStartupMessages({\n  library(Spaniel)\n  #library(biomaRt)\n  library(SingleCellExperiment)\n  library(Matrix)\n  library(dplyr)\n  library(scran)\n  library(SingleR)\n  library(scater)\n  library(ggplot2)\n  library(patchwork)\n})\n```\n:::\n\n{{< meta st_prep_2 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\npath_data = \"https://export.uppmax.uu.se/naiss2023-23-3/workshops/workshop-scrnaseq\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nif (!dir.exists(\"data/spatial/visium/Anterior\")) dir.create(\"data/spatial/visium/Anterior\", recursive = T)\nif (!dir.exists(\"data/spatial/visium/Posterior\")) dir.create(\"data/spatial/visium/Posterior\", recursive = T)\n\nfile_list <- c(\n    \"spatial/visium/Anterior/V1_Mouse_Brain_Sagittal_Anterior_filtered_feature_bc_matrix.tar.gz\",\n    \"spatial/visium/Anterior/V1_Mouse_Brain_Sagittal_Anterior_spatial.tar.gz\",\n    \"spatial/visium/Posterior/V1_Mouse_Brain_Sagittal_Posterior_filtered_feature_bc_matrix.tar.gz\",\n    \"spatial/visium/Posterior/V1_Mouse_Brain_Sagittal_Posterior_spatial.tar.gz\"\n)\n\nfor (i in file_list) {\n    if (!file.exists(file.path(\"data\", i))) {\n        cat(paste0(\"Downloading \", file.path(path_data, i), \" to \", file.path(\"data\", i), \"\\n\"))\n        download.file(url = file.path(path_data, i), destfile = file.path(\"data\", i))\n    }\n    cat(paste0(\"Uncompressing \", file.path(\"data\", i), \"\\n\"))\n    system(paste0(\"tar -xvzf \", file.path(\"data\", i), \" -C \", dirname(file.path(\"data\", i))))\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDownloading https://export.uppmax.uu.se/naiss2023-23-3/workshops/workshop-scrnaseq/spatial/visium/Anterior/V1_Mouse_Brain_Sagittal_Anterior_filtered_feature_bc_matrix.tar.gz to data/spatial/visium/Anterior/V1_Mouse_Brain_Sagittal_Anterior_filtered_feature_bc_matrix.tar.gz\nUncompressing data/spatial/visium/Anterior/V1_Mouse_Brain_Sagittal_Anterior_filtered_feature_bc_matrix.tar.gz\nDownloading https://export.uppmax.uu.se/naiss2023-23-3/workshops/workshop-scrnaseq/spatial/visium/Anterior/V1_Mouse_Brain_Sagittal_Anterior_spatial.tar.gz to data/spatial/visium/Anterior/V1_Mouse_Brain_Sagittal_Anterior_spatial.tar.gz\nUncompressing data/spatial/visium/Anterior/V1_Mouse_Brain_Sagittal_Anterior_spatial.tar.gz\nDownloading https://export.uppmax.uu.se/naiss2023-23-3/workshops/workshop-scrnaseq/spatial/visium/Posterior/V1_Mouse_Brain_Sagittal_Posterior_filtered_feature_bc_matrix.tar.gz to data/spatial/visium/Posterior/V1_Mouse_Brain_Sagittal_Posterior_filtered_feature_bc_matrix.tar.gz\nUncompressing data/spatial/visium/Posterior/V1_Mouse_Brain_Sagittal_Posterior_filtered_feature_bc_matrix.tar.gz\nDownloading https://export.uppmax.uu.se/naiss2023-23-3/workshops/workshop-scrnaseq/spatial/visium/Posterior/V1_Mouse_Brain_Sagittal_Posterior_spatial.tar.gz to data/spatial/visium/Posterior/V1_Mouse_Brain_Sagittal_Posterior_spatial.tar.gz\nUncompressing data/spatial/visium/Posterior/V1_Mouse_Brain_Sagittal_Posterior_spatial.tar.gz\n```\n:::\n:::\n\n\nMerge the objects into one SCE object.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsce.a <- Spaniel::createVisiumSCE(tenXDir = \"data/spatial/visium/Anterior\", resolution = \"Low\")\nsce.p <- Spaniel::createVisiumSCE(tenXDir = \"data/spatial/visium/Posterior\", resolution = \"Low\")\nsce <- cbind(sce.a, sce.p)\n\nsce$Sample <- basename(sub(\"/filtered_feature_bc_matrix\", \"\", sce$Sample))\n\nlll <- list(sce.a, sce.p)\nlll <- lapply(lll, function(x) x@metadata)\nnames(lll) <- c(\"Anterior\", \"Posterior\")\nsce@metadata <- lll\n```\n:::\n\n\nWe can further convert the gene ensembl IDs to gene names using biomaRt.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmart <- biomaRt::useMart(biomart = \"ENSEMBL_MART_ENSEMBL\", dataset = \"mmusculus_gene_ensembl\")\nannot <- biomaRt::getBM(attributes = c(\"ensembl_gene_id\", \"external_gene_name\", \"gene_biotype\"), mart = mart, useCache = F)\nsaveRDS(annot, \"data/spatial/visium/annot.rds\")\n```\n:::\n\n\nWe will use a file that was created in advance.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npath_file <- \"data/spatial/visium/annot.rds\"\nif (!file.exists(path_file)) download.file(url = file.path(path_data, \"spatial/visium/annot.rds\"), destfile = path_file)\nannot <- readRDS(path_file)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngene_names <- as.character(annot[match(rownames(sce), annot[, \"ensembl_gene_id\"]), \"external_gene_name\"])\ngene_names[is.na(gene_names)] <- \"\"\n\nsce <- sce[gene_names != \"\", ]\nrownames(sce) <- gene_names[gene_names != \"\"]\ndim(sce)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 32053  6050\n```\n:::\n:::\n\n\n## {{< meta st_qc >}}\n\n\n{{< meta st_qc_1 >}}\n\n\n\nNow the counts and feature counts are calculated on the Spatial assay, so they are named  **nCount_Spatial** and **nFeature_Spatial**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Mitochondrial genes\nmito_genes <- rownames(sce)[grep(\"^mt-\", rownames(sce))]\n\n# Ribosomal genes\nribo_genes <- rownames(sce)[grep(\"^Rp[sl]\", rownames(sce))]\n\n# Hemoglobin genes - includes all genes starting with HB except HBP.\nhb_genes <- rownames(sce)[grep(\"^Hb[^(p)]\", rownames(sce))]\n\nsce <- addPerCellQC(sce, flatten = T, subsets = list(mt = mito_genes, hb = hb_genes, ribo = ribo_genes))\n\nhead(colData(sce))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDataFrame with 6 rows and 24 columns\n       Sample            Barcode   Section    Spot_Y    Spot_X   Image_Y\n  <character>        <character> <integer> <integer> <integer> <integer>\n1    Anterior AAACAAGTATCTCCCA-1         1        50       102      7474\n2    Anterior AAACACCAATAACTGC-1         1        59        19      8552\n3    Anterior AAACAGAGCGACTCCT-1         1        14        94      3163\n4    Anterior AAACAGCTTTCAGAAG-1         1        43         9      6636\n5    Anterior AAACAGGGTCTATATT-1         1        47        13      7115\n6    Anterior AAACATGGTGAGAGGA-1         1        62         0      8912\n    Image_X   pixel_x   pixel_y       sum  detected     total       sum\n  <integer> <numeric> <numeric> <numeric> <integer> <numeric> <numeric>\n1      8500   438.898   214.079     13991      4462     13991     13960\n2      2788   143.959   158.417     39797      8126     39797     39742\n3      7950   410.499   436.678     29951      6526     29951     29905\n4      2100   108.434   257.349     42333      8190     42333     42262\n5      2375   122.633   232.616     35700      8090     35700     35660\n6      1480    76.420   139.828     22148      6518     22148     22096\n   detected subsets_mt_sum subsets_mt_detected subsets_mt_percent\n  <integer>      <numeric>           <integer>          <numeric>\n1      4458           1521                  12           10.89542\n2      8116           3977                  12           10.00705\n3      6520           4265                  12           14.26183\n4      8181           2870                  12            6.79097\n5      8083           1831                  13            5.13460\n6      6509           2390                  12           10.81644\n  subsets_hb_sum subsets_hb_detected subsets_hb_percent subsets_ribo_sum\n       <numeric>           <integer>          <numeric>        <numeric>\n1             60                   4           0.429799              826\n2            831                   6           2.090987             2199\n3            111                   5           0.371175             1663\n4            117                   5           0.276844             3129\n5             73                   5           0.204711             2653\n6            134                   5           0.606445             1478\n  subsets_ribo_detected subsets_ribo_percent     total\n              <integer>            <numeric> <numeric>\n1                    85              5.91691     13960\n2                    89              5.53319     39742\n3                    88              5.56094     29905\n4                    88              7.40381     42262\n5                    90              7.43971     35660\n6                    84              6.68899     22096\n```\n:::\n\n```{.r .cell-code}\nwrap_plots(plotColData(sce, y = \"detected\", x = \"Sample\", colour_by = \"Sample\"),\n    plotColData(sce, y = \"total\", x = \"Sample\", colour_by = \"Sample\"),\n    plotColData(sce, y = \"subsets_mt_percent\", x = \"Sample\", colour_by = \"Sample\"),\n    plotColData(sce, y = \"subsets_ribo_percent\", x = \"Sample\", colour_by = \"Sample\"),\n    plotColData(sce, y = \"subsets_hb_percent\", x = \"Sample\", colour_by = \"Sample\"),\n    ncol = 3\n)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-8-1.png){width=1056}\n:::\n:::\n\n{{< meta st_qc_2 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsamples <- c(\"Anterior\", \"Posterior\")\nto_plot <- c(\"detected\", \"total\", \"subsets_mt_percent\", \"subsets_ribo_percent\", \"subsets_hb_percent\")\n\nplist <- list()\nn <- 1\nfor (j in to_plot) {\n    for (i in samples) {\n        temp <- sce[, sce$Sample == i]\n        temp@metadata <- temp@metadata[[i]]\n        plist[[n]] <- spanielPlot(\n            object = temp,\n            plotType = \"Cluster\",\n            clusterRes = j, customTitle = j,\n            techType = \"Visium\",\n            ptSizeMax = 1, ptSizeMin = .1\n        )\n        n <- n + 1\n    }\n}\n\nwrap_plots(plist, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-9-1.png){width=768}\n:::\n:::\n\n{{< meta st_qc_3 >}}\n\n\n\n### {{< meta st_qc_filter >}}\n\n\n{{< meta st_qc_filter_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsce <- sce[ , sce$detected > 500 &\n              sce$subsets_mt_percent < 25 &\n              sce$subsets_hb_percent < 20]\ndim(sce)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 32053  5804\n```\n:::\n:::\n\n\nAnd replot onto tissue section:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsamples <- c(\"Anterior\", \"Posterior\")\nto_plot <- c(\"detected\", \"total\", \"subsets_mt_percent\", \"subsets_mt_percent\", \"subsets_hb_percent\")\n\nplist <- list()\nn <- 1\nfor (j in to_plot) {\n    for (i in samples) {\n        temp <- sce[, sce$Sample == i]\n        temp@metadata <- temp@metadata[[i]]\n        plist[[n]] <- spanielPlot(\n            object = temp,\n            plotType = \"Cluster\",\n            clusterRes = j, customTitle = j,\n            techType = \"Visium\",\n            ptSizeMax = 1, ptSizeMin = .1\n        )\n        n <- n + 1\n    }\n}\n\nwrap_plots(plist, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-11-1.png){width=768}\n:::\n:::\n\n\n### {{< meta st_qc_top >}}\n\n\n{{< meta st_qc_top_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nC <- counts(sce)\nC@x <- C@x / rep.int(colSums(C), diff(C@p))\nmost_expressed <- order(Matrix::rowSums(C), decreasing = T)[20:1]\nboxplot(as.matrix(t(C[most_expressed, ])), cex = .1, las = 1, xlab = \"% total count per cell\", col = scales::hue_pal()(20)[20:1], horizontal = TRUE)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-12-1.png){width=576}\n:::\n\n```{.r .cell-code}\nrm(C)\n```\n:::\n\n{{< meta st_qc_top_2 >}}\n\n\n\n### {{< meta st_qc_filterg >}}\n\n\n{{< meta st_qc_filterg_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(sce)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 32053  5804\n```\n:::\n\n```{.r .cell-code}\n# Filter Bl1\nsce <- sce[!grepl(\"Bc1\", rownames(sce)), ]\n\n# Filter Mitocondrial\nsce <- sce[!grepl(\"^mt-\", rownames(sce)), ]\n\n# Filter Hemoglobin gene (optional if that is a problem on your data)\nsce <- sce[!grepl(\"^Hb.*-\", rownames(sce)), ]\n\ndim(sce)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 32031  5804\n```\n:::\n:::\n\n\n## {{< meta st_analysis >}}\n\n\n{{< meta st_analysis_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsce <- computeSumFactors(sce, sizes=c(20, 40, 60, 80))\nsce <- logNormCounts(sce)\n```\n:::\n\n{{< meta st_analysis_2 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsamples <- c(\"Anterior\", \"Posterior\")\nto_plot <- c(\"Hpca\", \"Ttr\")\n\nplist <- list()\nn <- 1\nfor (j in to_plot) {\n    for (i in samples) {\n        temp <- sce[, sce$Sample == i]\n        temp@metadata <- temp@metadata[[i]]\n        plist[[n]] <- spanielPlot(\n            object = temp,\n            plotType = \"Gene\",\n            gene = j,\n            customTitle = j,\n            techType = \"Visium\",\n            ptSizeMax = 1, ptSizeMin = .1\n        )\n        n <- n + 1\n    }\n}\n\nwrap_plots(plist, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-15-1.png){width=624}\n:::\n:::\n\n\n### {{< meta st_analysis_dimred >}}\n\n\n{{< meta st_analysis_dimred_1 >}}\n\n\n\nBut make sure you run it on the `SCT` assay.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvar.out <- modelGeneVar(sce, method = \"loess\")\nhvgs <- getTopHVGs(var.out, n = 2000)\nsce <- runPCA(sce,\n    exprs_values = \"logcounts\",\n    subset_row = hvgs,\n    ncomponents = 50,\n    ntop = 100,\n    scale = T\n)\ng <- buildSNNGraph(sce, k = 5, use.dimred = \"PCA\")\nsce$louvain_SNNk5 <- factor(igraph::cluster_louvain(g)$membership)\nsce <- runUMAP(sce,\n    dimred = \"PCA\", n_dimred = 50, ncomponents = 2, min_dist = 0.1, spread = .3,\n    metric = \"correlation\", name = \"UMAP_on_PCA\"\n)\n```\n:::\n\n{{< meta st_analysis_dimred_2 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsamples <- c(\"Anterior\", \"Posterior\")\nto_plot <- c(\"louvain_SNNk5\")\n\nplist <- list()\nn <- 1\nfor (j in to_plot) {\n    for (i in samples) {\n        temp <- sce[, sce$Sample == i]\n        temp@metadata <- temp@metadata[[i]]\n        plist[[n]] <- spanielPlot(\n            object = temp,\n            plotType = \"Cluster\", clusterRes = j,\n            customTitle = j,\n            techType = \"Visium\",\n            ptSizeMax = 1, ptSizeMin = .1\n        )\n        n <- n + 1\n    }\n}\n\nplist[[3]] <- plotReducedDim(sce, dimred = \"UMAP_on_PCA\", colour_by = \"louvain_SNNk5\")\nplist[[4]] <- plotReducedDim(sce, dimred = \"UMAP_on_PCA\", colour_by = \"Sample\")\n\nwrap_plots(plist, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-17-1.png){width=864}\n:::\n:::\n\n\n### {{< meta st_analysis_int >}}\n\n\n{{< meta st_analysis_int_1 >}}\n\n\n\nWe will do a similar integration as in the Data Integration lab.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmnn_out <- batchelor::fastMNN(sce, subset.row = hvgs, batch = factor(sce$Sample), k = 20, d = 50)\n\nreducedDim(sce, \"MNN\") <- reducedDim(mnn_out, \"corrected\")\nrm(mnn_out)\ngc()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            used   (Mb) gc trigger   (Mb)  max used   (Mb)\nNcells  10048439  536.7   17579077  938.9  17579077  938.9\nVcells 191631135 1462.1  374124374 2854.4 373967307 2853.2\n```\n:::\n:::\n\n{{< meta st_analysis_int_2 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng <- buildSNNGraph(sce, k = 5, use.dimred = \"MNN\")\nsce$louvain_SNNk5 <- factor(igraph::cluster_louvain(g)$membership)\nsce <- runUMAP(sce,\n    dimred = \"MNN\", n_dimred = 50, ncomponents = 2, min_dist = 0.1, spread = .3,\n    metric = \"correlation\", name = \"UMAP_on_MNN\"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsamples <- c(\"Anterior\", \"Posterior\")\nto_plot <- c(\"louvain_SNNk5\")\n\nplist <- list()\nn <- 1\nfor (j in to_plot) {\n    for (i in samples) {\n        temp <- sce[, sce$Sample == i]\n        temp@metadata <- temp@metadata[[i]]\n        plist[[n]] <- spanielPlot(\n            object = temp,\n            plotType = \"Cluster\", clusterRes = j,\n            customTitle = j,\n            techType = \"Visium\",\n            ptSizeMax = 1, ptSizeMin = .1\n        )\n        n <- n + 1\n    }\n}\n\nplist[[3]] <- plotReducedDim(sce, dimred = \"UMAP_on_MNN\", colour_by = \"louvain_SNNk5\")\nplist[[4]] <- plotReducedDim(sce, dimred = \"UMAP_on_MNN\", colour_by = \"Sample\")\n\nwrap_plots(plist, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-20-1.png){width=864}\n:::\n:::\n\n\n:::{.callout-note title=\"Discuss\"}\n\n{{< meta st_analysis_int_3 >}}\n\n\n:::\n\n### {{< meta st_analysis_svg >}}\n\n\n{{< meta st_analysis_svg_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# differential expression between cluster 4 and cluster 6\ncell_selection <- sce[, sce$louvain_SNNk5 %in% c(4, 6)]\ncell_selection$louvain_SNNk5 <- factor(cell_selection$louvain_SNNk5)\n\nmarkers_genes <- scran::findMarkers(\n    x = cell_selection,\n    groups = cell_selection$louvain_SNNk5,\n    lfc = .25,\n    pval.type = \"all\",\n    direction = \"up\"\n)\n\n# List of dataFrames with the results for each cluster\ntop5_cell_selection <- lapply(names(markers_genes), function(x) {\n    temp <- markers_genes[[x]][1:5, 1:2]\n    temp$gene <- rownames(markers_genes[[x]])[1:5]\n    temp$cluster <- x\n    return(temp)\n})\ntop5_cell_selection <- as_tibble(do.call(rbind, top5_cell_selection))\ntop5_cell_selection\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"p.value\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"FDR\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"gene\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"cluster\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"6.851836e-146\",\"2\":\"2.194711e-141\",\"3\":\"Gng4\",\"4\":\"4\"},{\"1\":\"6.479022e-120\",\"2\":\"1.037648e-115\",\"3\":\"Gpsm1\",\"4\":\"4\"},{\"1\":\"6.818913e-110\",\"2\":\"7.280553e-106\",\"3\":\"Pcbp3\",\"4\":\"4\"},{\"1\":\"1.972611e-107\",\"2\":\"1.579618e-103\",\"3\":\"Synpr\",\"4\":\"4\"},{\"1\":\"2.155762e-98\",\"2\":\"1.381024e-94\",\"3\":\"Meis2\",\"4\":\"4\"},{\"1\":\"1.835576e-166\",\"2\":\"5.879534e-162\",\"3\":\"Ptgds\",\"4\":\"6\"},{\"1\":\"7.135306e-117\",\"2\":\"1.142755e-112\",\"3\":\"Atp1a2\",\"4\":\"6\"},{\"1\":\"6.606259e-92\",\"2\":\"7.053503e-88\",\"3\":\"Id3\",\"4\":\"6\"},{\"1\":\"3.592030e-88\",\"2\":\"2.876408e-84\",\"3\":\"Apoe\",\"4\":\"6\"},{\"1\":\"9.251824e-82\",\"2\":\"5.926903e-78\",\"3\":\"Apod\",\"4\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n# plot top markers\nsamples <- c(\"Anterior\", \"Posterior\")\nto_plot <- top5_cell_selection$gene[1:5]\n\nplist <- list()\nn <- 1\nfor (j in to_plot) {\n    for (i in samples) {\n        temp <- sce[, sce$Sample == i]\n        temp@metadata <- temp@metadata[[i]]\n        plist[[n]] <- spanielPlot(\n            object = temp,\n            plotType = \"Gene\",\n            gene = j,\n            customTitle = j,\n            techType = \"Visium\",\n            ptSizeMax = 1, ptSizeMin = .1\n        )\n        n <- n + 1\n    }\n}\nwrap_plots(plist, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n## {{< meta st_ss >}}\n\n\n{{< meta st_ss_1 >}}\n\n\n\nFirst dowload the seurat data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npath_file <- \"data/spatial/visium/allen_cortex.rds\"\nif (!file.exists(path_file)) download.file(url = file.path(path_data, \"spatial/visium/allen_cortex.rds\"), destfile = path_file)\n```\n:::\n\n{{< meta st_ss_2 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nar <- readRDS(path_file)\nar_sce <- Seurat::as.SingleCellExperiment(ar)\nrm(ar)\ngc()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            used   (Mb) gc trigger   (Mb)  max used   (Mb)\nNcells  10154274  542.3   17579077  938.9  17579077  938.9\nVcells 576426602 4397.8  831418709 6343.3 576864625 4401.2\n```\n:::\n\n```{.r .cell-code}\n# check number of cells per subclass\nar_sce$subclass <- sub(\"/\", \"_\", sub(\" \", \"_\", ar_sce$subclass))\ntable(ar_sce$subclass)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n     Astro         CR       Endo    L2_3_IT         L4      L5_IT      L5_PT \n       368          7         94        982       1401        880        544 \n     L6_CT      L6_IT        L6b      Lamp5 Macrophage      Meis2         NP \n       960       1872        358       1122         51         45        362 \n     Oligo       Peri      Pvalb   Serpinf1        SMC       Sncg        Sst \n        91         32       1337         27         55        125       1741 \n       Vip       VLMC \n      1728         67 \n```\n:::\n\n```{.r .cell-code}\n# select 20 cells per subclass, fist set subclass as active.ident\nsubset_cells <- lapply(unique(ar_sce$subclass), function(x) {\n    if (sum(ar_sce$subclass == x) > 20) {\n        temp <- sample(colnames(ar_sce)[ar_sce$subclass == x], size = 20)\n    } else {\n        temp <- colnames(ar_sce)[ar_sce$subclass == x]\n    }\n})\nar_sce <- ar_sce[, unlist(subset_cells)]\n\n# check again number of cells per subclass\ntable(ar_sce$subclass)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n     Astro         CR       Endo    L2_3_IT         L4      L5_IT      L5_PT \n        20          7         20         20         20         20         20 \n     L6_CT      L6_IT        L6b      Lamp5 Macrophage      Meis2         NP \n        20         20         20         20         20         20         20 \n     Oligo       Peri      Pvalb   Serpinf1        SMC       Sncg        Sst \n        20         20         20         20         20         20         20 \n       Vip       VLMC \n        20         20 \n```\n:::\n:::\n\n\nThen run normalization and dimensionality reduction.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nar_sce <- computeSumFactors(ar_sce, sizes=c(20, 40, 60, 80))\nar_sce <- logNormCounts(ar_sce)\nallen.var.out <- modelGeneVar(ar_sce, method=\"loess\")\nallen.hvgs = getTopHVGs(allen.var.out, n=2000)\n```\n:::\n\n\n## {{< meta st_sub >}}\n\n\n{{< meta st_sub_1 >}}\n\n\n\n### Integrate with scRNAseq\n\nHere, will use SingleR for prediciting which cell types are present in the dataset. We can first select the anterior part as an example (to speed up predictions).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsce.anterior <- sce[, sce$Sample == \"Anterior\"]\nsce.anterior@metadata <- sce.anterior@metadata[[\"Anterior\"]]\n```\n:::\n\n\nNext, we select the highly variable genes that are present in both datasets.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Find common highly variable genes\ncommon_hvgs <- intersect(allen.hvgs,hvgs)\n\n#Predict cell classes\npred.grun <- SingleR(test=sce.anterior[common_hvgs,],\n                     ref=ar_sce[common_hvgs,],\n                     labels=ar_sce$subclass)\n\n#Transfer the classes to the SCE object\nsce.anterior$cell_prediction <- pred.grun$labels\nsce.anterior@colData <- cbind(sce.anterior@colData,\n                              as.data.frame.matrix(table(list(1:ncol(sce.anterior),sce.anterior$cell_prediction))))\n```\n:::\n\n\nThen we can plot the predicted cell populations back to tissue.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot cell predictions\nspanielPlot(\n    object = sce.anterior,\n    plotType = \"Cluster\",\n    clusterRes = \"cell_prediction\",\n    customTitle = \"cell_prediction\",\n    techType = \"Visium\",\n    ptSizeMax = 1, ptSizeMin = .1\n)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-26-1.png){width=528}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplist <- list()\nn <- 1\nfor (i in c(\"L2_3_IT\", \"L4\", \"L5_IT\", \"L6_IT\")) {\n    plist[[n]] <- spanielPlot(\n        object = sce.anterior,\n        plotType = \"Cluster\",\n        clusterRes = i,\n        customTitle = i,\n        techType = \"Visium\", ptSize = .3,\n        ptSizeMax = 1, ptSizeMin = .1\n    )\n    n <- n + 1\n}\nwrap_plots(plist, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-27-1.png){width=864}\n:::\n:::\n\n\nKeep in mind, that the scores are \"just\" prediction scores, and do not correspond to proportion of cells that are of a certain celltype or similar. It mainly tell you that gene expression in a certain spot is hihgly similar/dissimilar to gene expression of a celltype. If we look at the scores, we see that some spots got really clear predictions by celltype, while others did not have high scores for any of the celltypes.\n\nWe can also plot the gene expression and add filters together, too:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspanielPlot(\n    object = sce.anterior,\n    plotType = \"Gene\",\n    gene = \"Wfs1\",\n    showFilter = sce.anterior$L4,\n    customTitle = \"\",\n    techType = \"Visium\",\n    ptSize = 0, ptSizeMin = -.3, ptSizeMax = 1\n)\n```\n\n::: {.cell-output-display}\n![](bioc_07_spatial_files/figure-html/unnamed-chunk-28-1.png){width=624}\n:::\n:::\n\n\n## {{< meta session >}}\n\n<details>\n  <summary>Click here</summary>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.3 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 \nLAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: Etc/UTC\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.1.3             scater_1.30.1              \n [3] ggplot2_3.4.4               SingleR_2.4.0              \n [5] scran_1.30.0                scuttle_1.12.0             \n [7] dplyr_1.1.4                 Matrix_1.6-4               \n [9] SingleCellExperiment_1.24.0 SummarizedExperiment_1.32.0\n[11] Biobase_2.62.0              GenomicRanges_1.54.1       \n[13] GenomeInfoDb_1.38.2         IRanges_2.36.0             \n[15] S4Vectors_0.40.2            BiocGenerics_0.48.1        \n[17] MatrixGenerics_1.14.0       matrixStats_1.2.0          \n[19] Spaniel_1.16.0             \n\nloaded via a namespace (and not attached):\n  [1] RcppAnnoy_0.0.21          batchelor_1.18.0         \n  [3] splines_4.3.2             later_1.3.2              \n  [5] bitops_1.0-7              R.oo_1.25.0              \n  [7] tibble_3.2.1              polyclip_1.10-6          \n  [9] fastDummies_1.7.3         lifecycle_1.0.4          \n [11] edgeR_4.0.3               globals_0.16.2           \n [13] lattice_0.21-9            MASS_7.3-60              \n [15] magrittr_2.0.3            limma_3.58.1             \n [17] plotly_4.10.3             rmarkdown_2.25           \n [19] yaml_2.3.8                metapod_1.10.1           \n [21] httpuv_1.6.13             Seurat_5.0.1             \n [23] sctransform_0.4.1         spam_2.10-0              \n [25] sp_2.1-2                  spatstat.sparse_3.0-3    \n [27] reticulate_1.34.0         cowplot_1.1.2            \n [29] pbapply_1.7-2             RColorBrewer_1.1-3       \n [31] ResidualMatrix_1.12.0     abind_1.4-5              \n [33] zlibbioc_1.48.0           Rtsne_0.17               \n [35] R.utils_2.12.3            purrr_1.0.2              \n [37] RCurl_1.98-1.13           GenomeInfoDbData_1.2.11  \n [39] ggrepel_0.9.4             irlba_2.3.5.1            \n [41] listenv_0.9.0             spatstat.utils_3.0-4     \n [43] goftest_1.2-3             RSpectra_0.16-1          \n [45] spatstat.random_3.2-2     dqrng_0.3.2              \n [47] fitdistrplus_1.1-11       parallelly_1.36.0        \n [49] DelayedMatrixStats_1.24.0 DropletUtils_1.22.0      \n [51] leiden_0.4.3.1            codetools_0.2-19         \n [53] DelayedArray_0.28.0       tidyselect_1.2.0         \n [55] farver_2.1.1              viridis_0.6.4            \n [57] ScaledMatrix_1.10.0       spatstat.explore_3.2-5   \n [59] jsonlite_1.8.8            BiocNeighbors_1.20.1     \n [61] ellipsis_0.3.2            progressr_0.14.0         \n [63] ggridges_0.5.5            survival_3.5-7           \n [65] tools_4.3.2               ica_1.0-3                \n [67] Rcpp_1.0.11               glue_1.6.2               \n [69] gridExtra_2.3             SparseArray_1.2.3        \n [71] xfun_0.41                 HDF5Array_1.30.0         \n [73] withr_2.5.2               fastmap_1.1.1            \n [75] rhdf5filters_1.14.1       bluster_1.12.0           \n [77] fansi_1.0.6               digest_0.6.33            \n [79] rsvd_1.0.5                R6_2.5.1                 \n [81] mime_0.12                 colorspace_2.1-0         \n [83] scattermore_1.2           tensor_1.5               \n [85] spatstat.data_3.0-3       R.methodsS3_1.8.2        \n [87] utf8_1.2.4                tidyr_1.3.0              \n [89] generics_0.1.3            data.table_1.14.10       \n [91] httr_1.4.7                htmlwidgets_1.6.4        \n [93] S4Arrays_1.2.0            uwot_0.1.16              \n [95] pkgconfig_2.0.3           gtable_0.3.4             \n [97] lmtest_0.9-40             XVector_0.42.0           \n [99] htmltools_0.5.7           dotCall64_1.1-1          \n[101] SeuratObject_5.0.1        scales_1.3.0             \n[103] png_0.1-8                 knitr_1.45               \n[105] reshape2_1.4.4            nlme_3.1-163             \n[107] rhdf5_2.46.1              zoo_1.8-12               \n[109] stringr_1.5.1             KernSmooth_2.23-22       \n[111] vipor_0.4.7               parallel_4.3.2           \n[113] miniUI_0.1.1.1            pillar_1.9.0             \n[115] grid_4.3.2                vctrs_0.6.5              \n[117] RANN_2.6.1                promises_1.2.1           \n[119] BiocSingular_1.18.0       beachmat_2.18.0          \n[121] xtable_1.8-4              cluster_2.1.4            \n[123] beeswarm_0.4.0            evaluate_0.23            \n[125] cli_3.6.2                 locfit_1.5-9.8           \n[127] compiler_4.3.2            rlang_1.1.2              \n[129] crayon_1.5.2              future.apply_1.11.1      \n[131] labeling_0.4.3            ggbeeswarm_0.7.2         \n[133] plyr_1.8.9                stringi_1.8.3            \n[135] viridisLite_0.4.2         deldir_2.0-2             \n[137] BiocParallel_1.36.0       munsell_0.5.0            \n[139] lazyeval_0.2.2            spatstat.geom_3.2-7      \n[141] RcppHNSW_0.5.0            sparseMatrixStats_1.14.0 \n[143] future_1.33.1             Rhdf5lib_1.24.1          \n[145] statmod_1.5.0             shiny_1.8.0              \n[147] ROCR_1.0-11               igraph_1.6.0             \n```\n:::\n:::\n\n\n</details>\n",
    "supporting": [
      "bioc_07_spatial_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}