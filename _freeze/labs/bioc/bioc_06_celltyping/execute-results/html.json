{
  "hash": "5bcfc2c25b2967d9be27d5aa49eb8999",
  "result": {
    "markdown": "---\ntitle: \"{{< meta ct_title >}}\"\nsubtitle: \"{{< meta subtitle_bioc >}}\"\ndescription: \"{{< meta ct_description >}}\"\nformat: html\n---\n\n\n::: {.callout-note}\nCode chunks run R commands unless otherwise specified.\n:::\n\n\n{{< meta ct_1 >}}\n\n\n{{< meta ct_2 >}}\n\n\n\n## {{< meta ct_read >}}\n\n\n{{< meta ct_read_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\n  library(scater)\n  library(scran)\n  library(dplyr)\n  library(cowplot)\n  library(ggplot2)\n  library(pheatmap)\n  library(rafalib)\n  library(scPred)\n  library(scmap)\n})\n```\n:::\n\n{{< meta ct_read_2 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#load the data and select 'ctrl_13` sample\nalldata <- readRDS(\"data/results/covid_qc_dr_int_cl.rds\")\n```\n:::\n\n{{< meta ct_read_2 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nctrl.sce <- alldata[, alldata@colData$sample == 'ctrl.13']\n\n# remove all old dimensionality reductions as they will mess up the analysis further down\nreducedDims(ctrl.sce) <- NULL\n```\n:::\n\n\n## {{< meta ct_ref >}}\n\n\n{{< meta ct_ref_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreference <- scPred::pbmc_1\nreference\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAn object of class Seurat \n32838 features across 3500 samples within 1 assay \nActive assay: RNA (32838 features, 0 variable features)\n```\n:::\n:::\n\n\nConvert to a SCE object.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nref.sce = Seurat::as.SingleCellExperiment(reference)\n```\n:::\n\n{{< meta ct_ref_2 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Normalize\nref.sce <- computeSumFactors(ref.sce)\nref.sce <- logNormCounts(ref.sce)\n\n#Variable genes\nvar.out <- modelGeneVar(ref.sce, method=\"loess\")\nhvg.ref <- getTopHVGs(var.out, n=1000)  \n\n# Dim reduction\nref.sce <- runPCA(ref.sce, exprs_values = \"logcounts\",  scale = T,\n              ncomponents = 30, subset_row = hvg.ref)\nref.sce <- runUMAP(ref.sce, dimred = \"PCA\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplotReducedDim(ref.sce,dimred = \"UMAP\",colour_by = \"cell_type\")\n```\n\n::: {.cell-output-display}\n![](bioc_06_celltyping_files/figure-html/unnamed-chunk-7-1.png){width=576}\n:::\n:::\n\n{{< meta ct_ref_3 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Normalize\nctrl.sce <- computeSumFactors(ctrl.sce)\nctrl.sce <- logNormCounts(ctrl.sce)\n\n#Variable genes\nvar.out <- modelGeneVar(ctrl.sce, method=\"loess\")\nhvg.ctrl <- getTopHVGs(var.out, n=1000)  \n\n# Dim reduction\nctrl.sce <- runPCA(ctrl.sce, exprs_values = \"logcounts\",  scale = T, ncomponents = 30, subset_row = hvg.ctrl)\nctrl.sce <- runUMAP(ctrl.sce, dimred = \"PCA\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplotReducedDim(ctrl.sce,dimred = \"UMAP\",colour_by = \"louvain_SNNk15\")\n```\n\n::: {.cell-output-display}\n![](bioc_06_celltyping_files/figure-html/unnamed-chunk-9-1.png){width=576}\n:::\n:::\n\n\n## scMap\n\nThe scMap package is one method for projecting cells from a scRNA-seq experiment on to the cell-types or individual cells identified in a different experiment. It can be run on different levels, either projecting by cluster or by single cell, here we will try out both.\n\nFor scmap cell type labels must be stored in the `cell_type1` column of the `colData` slots, and gene ids that are consistent across both datasets must be stored in the `feature_symbol` column of the `rowData` slots.\n\n### scMap cluster\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add in slot cell_type1\nref.sce@colData$cell_type1 = ref.sce@colData$cell_type\n# create a rowData slot with feature_symbol\nrd = data.frame(feature_symbol=rownames(ref.sce))\nrownames(rd) = rownames(ref.sce)\nrowData(ref.sce) = rd\n\n# same for the ctrl dataset\n# create a rowData slot with feature_symbol\nrd = data.frame(feature_symbol=rownames(ctrl.sce))\nrownames(rd) = rownames(ctrl.sce)\nrowData(ctrl.sce) = rd\n```\n:::\n\n\nThen we can select variable features in both datasets.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# select features\ncounts(ctrl.sce) <- as.matrix(counts(ctrl.sce))\nlogcounts(ctrl.sce) <- as.matrix(logcounts(ctrl.sce))\nctrl.sce <- selectFeatures(ctrl.sce, suppress_plot = TRUE)\n\ncounts(ref.sce) <- as.matrix(counts(ref.sce))\nlogcounts(ref.sce) <- as.matrix(logcounts(ref.sce))\nref.sce <- selectFeatures(ref.sce, suppress_plot = TRUE)\n```\n:::\n\n\nThen we need to index the reference dataset by cluster, default is the clusters in `cell_type1`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nref.sce <- indexCluster(ref.sce)\n```\n:::\n\n\nNow we project the Covid-19 dataset onto that index.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nproject_cluster <- scmapCluster(\n  projection = ctrl.sce,\n  index_list = list(\n    ref = metadata(ref.sce)$scmap_cluster_index\n  )\n)\n\n# projected labels\ntable(project_cluster$scmap_cluster_labs)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n     B cell  CD4 T cell  CD8 T cell         cDC       cMono      ncMono \n         66         108         133          38         217         144 \n    NK cell         pDC Plasma cell  unassigned \n        256           2           3         208 \n```\n:::\n:::\n\n\nThen add the predictions to metadata and plot UMAP.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add in predictions\nctrl.sce@colData$scmap_cluster <- project_cluster$scmap_cluster_labs\n\nplotReducedDim(ctrl.sce,dimred = \"UMAP\",colour_by = \"scmap_cluster\")\n```\n\n::: {.cell-output-display}\n![](bioc_06_celltyping_files/figure-html/unnamed-chunk-14-1.png){width=576}\n:::\n:::\n\n\n## scMap cell\n\nWe can instead index the refernce data based on each single cell and project our data onto the closest neighbor in that dataset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nref.sce <- indexCell(ref.sce)\n```\n:::\n\n\nAgain we need to index the reference dataset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nproject_cell <- scmapCell(\n  projection = ctrl.sce,\n  index_list = list(\n    ref = metadata(ref.sce)$scmap_cell_index\n  )\n)\n```\n:::\n\n\nWe now get a table with index for the 5 nearest neigbors in the reference dataset for each cell in our dataset. We will select the celltype of the closest neighbor and assign it to the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncell_type_pred <- colData(ref.sce)$cell_type1[project_cell$ref[[1]][1,]]\ntable(cell_type_pred)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\ncell_type_pred\n     B cell  CD4 T cell  CD8 T cell         cDC       cMono      ncMono \n        103         186         285          48         193         186 \n    NK cell         pDC Plasma cell \n        170           2           2 \n```\n:::\n:::\n\n\nThen add the predictions to metadata and plot umap.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add in predictions\nctrl.sce@colData$scmap_cell <- cell_type_pred\n\nplotReducedDim(ctrl.sce,dimred = \"UMAP\",colour_by = \"scmap_cell\")\n```\n\n::: {.cell-output-display}\n![](bioc_06_celltyping_files/figure-html/unnamed-chunk-18-1.png){width=576}\n:::\n:::\n\n\nPlot both:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncowplot::plot_grid( ncol = 2,\nplotReducedDim(ctrl.sce,dimred = \"UMAP\",colour_by = \"scmap_cluster\"),\nplotReducedDim(ctrl.sce,dimred = \"UMAP\",colour_by = \"scmap_cell\")\n)\n```\n\n::: {.cell-output-display}\n![](bioc_06_celltyping_files/figure-html/unnamed-chunk-19-1.png){width=960}\n:::\n:::\n\n\n## {{< meta ct_scpred >}}\n\n\n{{< meta ct_scpred_1 >}}\n\n\n\nscPred works with Seurat objects, so we will convert both objects to seurat objects. You may see a lot of warnings about renaming things, but as long as you do not see an Error, you should be fine.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages(library(Seurat))\n\nreference <- Seurat::as.Seurat(ref.sce)\nctrl <- Seurat::as.Seurat(ctrl.sce)\n```\n:::\n\n\nThe loadings matrix is lost when converted to Seurat object, and scPred needs that information. So we need to rerun PCA with Seurat and the same hvgs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nVariableFeatures(reference) = hvg.ref\nreference <- reference %>% ScaleData(verbose=F) %>% RunPCA(verbose=F)\n\nVariableFeatures(ctrl) = hvg.ctrl\nctrl <- ctrl %>% ScaleData(verbose=F) %>% RunPCA(verbose=F)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nreference <- getFeatureSpace(reference, \"cell_type\")\nreference <- trainModel(reference)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n●  Extracting feature space for each cell type...\nDONE!\n●  Training models for each cell type...\nDONE!\n```\n:::\n:::\n\n{{< meta ct_scpred_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_scpred(reference)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n'scPred' object\n✔  Prediction variable = cell_type \n✔  Discriminant features per cell type\n✔  Training model(s)\nSummary\n\n|Cell type   |    n| Features|Method    |   ROC|  Sens|  Spec|\n|:-----------|----:|--------:|:---------|-----:|-----:|-----:|\n|B cell      |  280|       50|svmRadial | 1.000| 1.000| 1.000|\n|CD4 T cell  | 1620|       50|svmRadial | 0.994| 0.972| 0.963|\n|CD8 T cell  |  945|       50|svmRadial | 0.973| 0.859| 0.971|\n|cDC         |   26|       50|svmRadial | 0.994| 0.727| 0.999|\n|cMono       |  212|       50|svmRadial | 1.000| 0.957| 0.997|\n|ncMono      |   79|       50|svmRadial | 1.000| 0.962| 0.999|\n|NK cell     |  312|       50|svmRadial | 0.998| 0.926| 0.995|\n|pDC         |   20|       50|svmRadial | 1.000| 0.950| 1.000|\n|Plasma cell |    6|       50|svmRadial | 1.000| 1.000| 1.000|\n```\n:::\n:::\n\n{{< meta ct_scpred_3 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nctrl <- scPredict(ctrl, reference)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n●  Matching reference with new dataset...\n\t ─ 1000 features present in reference loadings\n\t ─ 937 features shared between reference and new dataset\n\t ─ 93.7% of features in the reference are present in new dataset\n●  Aligning new data to reference...\n●  Classifying cells...\nDONE!\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nDimPlot(ctrl, group.by = \"scpred_prediction\", label = T, repel = T) + NoAxes()\n```\n\n::: {.cell-output-display}\n![](bioc_06_celltyping_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n{{< meta ct_scpred_4 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(ctrl@meta.data, aes(x=louvain_SNNk15, fill = scpred_prediction)) + geom_bar() + theme_classic()\n```\n\n::: {.cell-output-display}\n![](bioc_06_celltyping_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\nAdd the predictions into the SCE object\n\n\n::: {.cell}\n\n```{.r .cell-code}\nctrl.sce@colData$scpred_prediction = ctrl$scpred_prediction\n```\n:::\n\n\n## {{< meta ct_compare >}}\n\n\n{{< meta ct_compare_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncrossTab(ctrl, \"scmap_cell\", \"scpred_prediction\")\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|            | B cell| CD4 T cell| CD8 T cell| cDC| cMono| ncMono| NK cell| pDC| Plasma cell|\n|:-----------|------:|----------:|----------:|---:|-----:|------:|-------:|---:|-----------:|\n|B cell      |    100|          2|          1|   0|     1|      1|       0|   0|           0|\n|CD4 T cell  |      0|        150|         49|   0|     2|      1|       0|   0|           2|\n|CD8 T cell  |      1|         26|        181|   0|     1|      1|      71|   0|           0|\n|cDC         |      0|          0|          0|  14|     2|      5|       0|   0|           0|\n|cMono       |      0|          0|          0|  27|   165|     78|       0|   0|           0|\n|ncMono      |      0|          0|          0|   1|     9|     94|       0|   0|           0|\n|NK cell     |      0|          0|         33|   0|     0|      0|      86|   0|           0|\n|pDC         |      0|          0|          0|   1|     0|      0|       0|   1|           0|\n|Plasma cell |      1|          0|          0|   0|     1|      0|       0|   0|           0|\n|unassigned  |      1|          8|         21|   5|    12|      6|      13|   1|           0|\n\n</div>\n:::\n:::\n\n\n## {{< meta ct_gsea >}}\n\n\n{{< meta ct_gsea_1 >}}\n\n\n\n### {{< meta ct_gsea_deg >}}\n\n\n{{< meta ct_gsea_deg_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# run differential expression in our dataset, using clustering at resolution 0.3\nDGE_list <- scran::findMarkers(\n  x = alldata,\n  groups = as.character(alldata@colData$louvain_SNNk15),\n  pval.type = \"all\",\n  min.prop = 0\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compute differential gene expression in reference dataset (that has cell annotation)\nref_DGE <- scran::findMarkers(\n  x = ref.sce,\n  groups = as.character(ref.sce@colData$cell_type),\n  pval.type = \"all\",\n  direction = \"up\"\n)\n\n# Identify the top cell marker genes in reference dataset\n# select top 50 with hihgest foldchange among top 100 signifcant genes.\nref_list <- lapply(ref_DGE, function(x){\n  x$logFC <- rowSums( as.matrix( x[,grep(\"logFC\",colnames(x))] ))\n  x %>% as.data.frame() %>% filter(p.value < 0.01) %>% top_n(-100, p.value) %>% top_n(50, logFC) %>% rownames()\n  }\n)\n\nunlist(lapply(ref_list, length))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     B cell  CD4 T cell  CD8 T cell         cDC       cMono      ncMono \n         50          50          19          17          50          50 \n    NK cell         pDC Plasma cell \n         50          50          24 \n```\n:::\n:::\n\n{{< meta ct_gsea_deg_2 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages(library(fgsea))\n\n# run fgsea for each of the clusters in the list\nres <- lapply(DGE_list, function(x){\n  x$logFC <- rowSums( as.matrix( x[,grep(\"logFC\",colnames(x))] ))\n  gene_rank <- setNames(x$logFC, rownames(x))\n  fgseaRes <- fgsea( pathways=ref_list, stats=gene_rank,nperm=10000)\n  return(fgseaRes)\n})\nnames(res) <- names(DGE_list)\n\n# You can filter and resort the table based on ES, NES or pvalue\nres <- lapply(res, function(x) {x[ x$pval < 0.1 , ]} )\nres <- lapply(res, function(x) {x[ x$size > 2 , ]} )\nres <- lapply(res, function(x) {x[order(x$NES,decreasing = T), ]} )\nres\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$`1`\n      pathway         pval         padj         ES       NES nMoreExtreme size\n1:     B cell 0.0002217295 0.0004988914  0.9673024  2.031038            0   47\n2: CD4 T cell 0.0002202643 0.0004988914  0.8545399  1.814050            0   50\n3:        cDC 0.0004463289 0.0008033921  0.9501498  1.700971            1   17\n4: CD8 T cell 0.0023546459 0.0030274019 -0.8965135 -1.580857           12   17\n5:      cMono 0.0007283321 0.0010924982 -0.8096191 -1.679978            3   47\n6:     ncMono 0.0001830831 0.0004988914 -0.9077681 -1.892294            0   49\n7:    NK cell 0.0001830831 0.0004988914 -0.9103581 -1.897693            0   49\n                                               leadingEdge\n1:          MS4A1,CD37,TNFRSF13C,CXCR4,BANK1,LINC00926,...\n2:                   RPS29,RPS6,RPL13,RPL32,RPL3,RPL21,...\n3: HLA-DRA,HLA-DQB1,HLA-DPB1,HLA-DRB1,HLA-DPA1,HLA-DMA,...\n4:                        CCL5,IL32,GZMH,CD3D,CD2,LYAR,...\n5:                S100A6,S100A9,LYZ,S100A8,TYROBP,FCN1,...\n6:                S100A4,FCER1G,S100A11,AIF1,LST1,PSAP,...\n7:                     ITGB2,HCST,NKG7,GNLY,MYO1F,CST7,...\n\n$`2`\n      pathway         pval         padj         ES       NES nMoreExtreme size\n1:      cMono 0.0001835199 0.0006680027  0.9370766  1.937604            0   47\n2:     ncMono 0.0051048314 0.0076572470  0.7957849  1.655267           27   49\n3:        cDC 0.0416666667 0.0535714286 -0.7991890 -1.459012          206   17\n4: CD8 T cell 0.0014090177 0.0025362319 -0.8959826 -1.635720            6   17\n5:    NK cell 0.0004427718 0.0009962364 -0.8000009 -1.751729            1   49\n6:     B cell 0.0002196354 0.0006680027 -0.8607564 -1.871173            0   47\n7: CD4 T cell 0.0002226676 0.0006680027 -0.9382975 -2.058526            0   50\n                                                leadingEdge\n1:                  S100A8,S100A9,LYZ,S100A12,VCAN,RETN,...\n2:             S100A11,S100A4,AIF1,FCER1G,SERPINA1,MAFB,...\n3: HLA-DPB1,HLA-DPA1,HLA-DRB1,HLA-DRA,HLA-DQB1,HLA-DRB5,...\n4:                         IL32,CCL5,GZMH,CD3D,CD2,LYAR,...\n5:                       GNLY,B2M,GZMA,CTSW,IFITM1,NKG7,...\n6:                    RPL23A,RPS5,CXCR4,CD52,CD37,RPS23,...\n7:                   RPL14,RPL3,RPL5,EEF1A1,RPS4X,RPS3A,...\n\n$`3`\n      pathway         pval         padj         ES       NES nMoreExtreme size\n1: CD4 T cell 0.0002224199 0.0006672598  0.9813258  2.128941            0   50\n2:     B cell 0.0407844885 0.0524371995  0.6686418  1.434365          182   47\n3:    NK cell 0.0065406977 0.0098110465 -0.7485181 -1.575950           35   49\n4:        cDC 0.0009165903 0.0016498625 -0.9149281 -1.628638            4   17\n5:        pDC 0.0009066183 0.0016498625 -0.8112849 -1.696627            4   47\n6:      cMono 0.0001813237 0.0006672598 -0.9180190 -1.919838            0   47\n7:     ncMono 0.0001816860 0.0006672598 -0.9460470 -1.991833            0   49\n                                                leadingEdge\n1:                    IL7R,LDHB,PIK3IP1,RPL3,RPS12,RPS6,...\n2:                RPS5,RPL13A,RPL23A,RPL18A,RPS23,CXCR4,...\n3:                    NKG7,GNLY,ITGB2,MYO1F,CST7,FGFBP2,...\n4: HLA-DRA,HLA-DRB1,HLA-DPA1,HLA-DPB1,HLA-DQB1,HLA-DRB5,...\n5:                      PLEK,NPC2,PLAC8,CTSB,PTPRE,IRF8,...\n6:                 S100A9,S100A8,LYZ,TYROBP,FCN1,S100A6,...\n7:                 FCER1G,PSAP,AIF1,LST1,S100A11,IFITM3,...\n\n$`4`\n      pathway         pval         padj         ES       NES nMoreExtreme size\n1:        cDC 0.0077071291 0.0115606936  0.8207362  1.760240            7   17\n2:     ncMono 0.0031542425 0.0056776364 -0.7375920 -1.369139           29   49\n3:      cMono 0.0029548333 0.0056776364 -0.7470385 -1.380599           27   47\n4:    NK cell 0.0018925455 0.0056776364 -0.7580621 -1.407136           17   49\n5:     B cell 0.0001055298 0.0004748839 -0.7963073 -1.471653            0   47\n6: CD4 T cell 0.0001050089 0.0004748839 -0.9046016 -1.681425            0   50\n                                     leadingEdge\n1: HLA-DRB5,HLA-DRA,FCER1A,CLEC10A,CD1C,ENHO,...\n2:     S100A4,IFITM2,CEBPB,SAT1,S100A11,MT2A,...\n3:      JUND,S100A6,NFKBIA,TSPO,TYROBP,APLP2,...\n4:       ITGB2,IFITM1,JAK1,HCST,ABHD17A,CST7,...\n5:         CD52,RPL13A,CXCR4,RPS11,FAU,RPL12,...\n6:       RPL34,RPS29,RPS14,RPL36,RPL38,RPL30,...\n\n$`5`\n      pathway         pval        padj         ES       NES nMoreExtreme size\n1:     ncMono 0.0001116570 0.001004913  0.9745302  1.772389            0   49\n2:        cDC 0.0045213797 0.008138483  0.8981323  1.476628           34   17\n3:     B cell 0.0304386750 0.045658013 -0.5799813 -1.450314           33   47\n4: CD8 T cell 0.0004422822 0.001990270 -0.9261816 -1.888602            0   17\n5:    NK cell 0.0009560229 0.002173913 -0.8297171 -2.086492            0   49\n6: CD4 T cell 0.0009661836 0.002173913 -0.8672425 -2.186872            0   50\n                                              leadingEdge\n1:               LST1,AIF1,COTL1,FCGR3A,FCER1G,CDKN1C,...\n2: HLA-DPA1,HLA-DRA,HLA-DPB1,HLA-DRB1,HLA-DRB5,MTMR14,...\n3:          CXCR4,RPL13A,MS4A1,TNFRSF13C,BANK1,RPL23A,...\n4:                       CCL5,IL32,GZMH,CD3D,CD2,CD8A,...\n5:                    NKG7,GNLY,CST7,GZMA,CTSW,FGFBP2,...\n6:                   LDHB,RPS3,IL7R,RPL31,RPL3,MGAT4A,...\n\n$`6`\n       pathway         pval         padj         ES       NES nMoreExtreme size\n1:     NK cell 0.0001904037 0.0003789474  0.9278653  1.970349            0   49\n2:  CD4 T cell 0.0001902226 0.0003789474  0.8977129  1.911785            0   50\n3:  CD8 T cell 0.0001960400 0.0003789474  0.9678948  1.727226            0   17\n4: Plasma cell 0.0206627680 0.0265664160  0.8106409  1.530539          105   24\n5:         cDC 0.0079575597 0.0119363395 -0.8724534 -1.575165           38   17\n6:      ncMono 0.0002105263 0.0003789474 -0.9136453 -1.973406            0   49\n7:       cMono 0.0002103492 0.0003789474 -0.9287764 -1.991235            0   47\n                                            leadingEdge\n1:                  NKG7,GNLY,CST7,GZMA,GZMM,FGFBP2,...\n2:                 IL7R,RPS3,RPS29,RPL3,RPS4X,RPL14,...\n3:                    CCL5,IL32,GZMH,CD3D,CD8A,LYAR,...\n4:             RPL36AL,FKBP11,PPIB,PEBP1,SUB1,ISG20,...\n5: HLA-DRA,HLA-DRB5,HLA-DMA,HLA-DQB1,BASP1,HLA-DRB1,...\n6:             FCER1G,AIF1,LST1,COTL1,PSAP,SERPINA1,...\n7:            S100A9,S100A8,LYZ,TYROBP,FCN1,S100A12,...\n\n$`7`\n      pathway         pval         padj         ES       NES nMoreExtreme size\n1:      cMono 0.0001218621 0.0005483792  0.9467983  1.785449            0   47\n2:     ncMono 0.0001213151 0.0005483792  0.9030393  1.710299            0   49\n3:        cDC 0.0071214927 0.0091562049  0.8950933  1.501784           49   17\n4: CD8 T cell 0.0003354579 0.0008605852 -0.9243425 -1.806868            0   17\n5:    NK cell 0.0005685048 0.0008605852 -0.8017599 -1.925679            0   49\n6:     B cell 0.0005567929 0.0008605852 -0.8747090 -2.082893            0   47\n7: CD4 T cell 0.0005737235 0.0008605852 -0.9046931 -2.179235            0   50\n                                               leadingEdge\n1:                  S100A8,S100A9,LYZ,FCN1,TYROBP,VCAN,...\n2:              AIF1,S100A11,FCER1G,PSAP,FTH1,SERPINA1,...\n3: HLA-DRA,HLA-DRB1,HLA-DRB5,HLA-DMA,HLA-DQB1,HLA-DPA1,...\n4:                        CCL5,IL32,GZMH,CD3D,CD2,CD8A,...\n5:                     NKG7,GNLY,CST7,GZMA,CTSW,FGFBP2,...\n6:                CXCR4,RPS5,RPL23A,CD52,RPL13A,RPL18A,...\n7:                   RPL3,RPS4X,RPS3,RPS29,RPS27A,IL7R,...\n\n$`8`\n      pathway         pval         padj         ES       NES nMoreExtreme size\n1:    NK cell 0.0002541296 0.0007623888  0.9803010  2.126177            0   49\n2: CD8 T cell 0.0114485981 0.0147196262  0.8783596  1.604619           48   17\n3:        cDC 0.0040195736 0.0060293604 -0.8891236 -1.573093           22   17\n4: CD4 T cell 0.0014797764 0.0026635975 -0.7886537 -1.644649            8   50\n5:     B cell 0.0006625808 0.0014908067 -0.8337404 -1.720942            3   47\n6:     ncMono 0.0001648261 0.0007454033 -0.8617479 -1.791643            0   49\n7:      cMono 0.0001656452 0.0007454033 -0.8964340 -1.850349            0   47\n                                               leadingEdge\n1:                     GNLY,NKG7,FGFBP2,PRF1,CTSW,CST7,...\n2:                   CCL5,GZMH,IL32,LYAR,LINC01871,CD2,...\n3: HLA-DRA,HLA-DRB1,HLA-DPA1,HLA-DQB1,HLA-DRB5,HLA-DMA,...\n4:                 RPS13,RPS28,TMEM123,RPL22,IL7R,TPT1,...\n5:                  CD37,RPS11,RPL18A,RPL12,CD52,RPS23,...\n6:                  COTL1,AIF1,FTH1,LST1,SAT1,SERPINA1,...\n7:                  S100A9,S100A8,LYZ,FCN1,TKT,S100A12,...\n```\n:::\n:::\n\n{{< meta ct_gsea_deg_3 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnew.cluster.ids <- unlist(lapply(res,function(x){as.data.frame(x)[1,1]}))\n\nalldata@colData$ref_gsea <- new.cluster.ids[as.character(alldata@colData$louvain_SNNk15)]\n\ncowplot::plot_grid( ncol = 2,\n   plotReducedDim(alldata, dimred = \"UMAP\",colour_by = \"louvain_SNNk15\"),\n   plotReducedDim(alldata, dimred = \"UMAP\",colour_by = \"ref_gsea\")\n)\n```\n\n::: {.cell-output-display}\n![](bioc_06_celltyping_files/figure-html/unnamed-chunk-32-1.png){width=960}\n:::\n:::\n\n{{< meta ct_gsea_deg_4 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nctrl.sce@colData$ref_gsea = alldata@colData$ref_gsea[alldata@colData$sample == \"ctrl.13\"]\n\ncowplot::plot_grid( ncol = 3,\n  plotReducedDim(ctrl.sce, dimred = \"UMAP\",colour_by = \"ref_gsea\"),\n  plotReducedDim(ctrl.sce, dimred = \"UMAP\",colour_by = \"scmap_cell\"),          \n  plotReducedDim(ctrl.sce, dimred = \"UMAP\",colour_by = \"scpred_prediction\")\n)\n```\n\n::: {.cell-output-display}\n![](bioc_06_celltyping_files/figure-html/unnamed-chunk-33-1.png){width=1344}\n:::\n:::\n\n\n### {{< meta ct_gsea_annot >}}\n\n\n{{< meta ct_gsea_annot_1 >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the human marker table\nmarkers <- read.delim(\"data/cellmarker/Human_cell_markers.txt\")\nmarkers <- markers [ markers$speciesType == \"Human\", ]\nmarkers <- markers [ markers$cancerType == \"Normal\", ]\n\n#Filter by tissue (to reduce computational time and have tissue-specific classification)\n# sort(unique(markers$tissueType))\n# grep(\"blood\",unique(markers$tissueType),value = T)\n# markers <- markers [ markers$tissueType %in% c(\"Blood\",\"Venous blood\",\n#                                                \"Serum\",\"Plasma\",\n#                                                \"Spleen\",\"Bone marrow\",\"Lymph node\"), ]\n\n\n# remove strange characters etc.\ncelltype_list <- lapply( unique(markers$cellName) , function(x){\n  x <- paste(markers$geneSymbol[markers$cellName == x],sep=\",\")\n  x <- gsub(\"[[]|[]]| |-\",\",\",x)\n  x <- unlist(strsplit( x , split = \",\"))\n  x <- unique(x [ ! x %in% c(\"\",\"NA\",\"family\") ])\n  x <- casefold(x,upper = T)\n})\nnames(celltype_list) <- unique(markers$cellName)\n# celltype_list <- lapply(celltype_list , function(x) {x[1:min(length(x),50)]} )\ncelltype_list <- celltype_list[ unlist(lapply(celltype_list,length)) < 100 ]\ncelltype_list <- celltype_list[ unlist(lapply(celltype_list,length)) > 5 ]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# run fgsea for each of the clusters in the list\nres <- lapply(DGE_list, function(x) {\n  x$logFC <- rowSums(as.matrix(x[, grep(\"logFC\", colnames(x))]))\n  gene_rank <- setNames(x$logFC, rownames(x))\n  fgseaRes <- fgsea(pathways = celltype_list, stats = gene_rank, nperm = 10000)\n  return(fgseaRes)\n})\nnames(res) <- names(DGE_list)\n\n# You can filter and resort the table based on ES, NES or pvalue\nres <- lapply(res, function(x) {x[ x$pval < 0.01 , ]} )\nres <- lapply(res, function(x) {x[ x$size > 5 , ]} )\nres <- lapply(res, function(x) {x[order(x$NES,decreasing = T), ]} )\n\n# show top 3 for each cluster.\nlapply(res,head,3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$`1`\n                       pathway        pval       padj         ES       NES\n1:              Pyramidal cell 0.006361085 0.07034612 -0.9654127 -1.467575\n2: Endothelial progenitor cell 0.009917665 0.08106613 -0.9485749 -1.468858\n3: CD4+CD25+ regulatory T cell 0.002245089 0.04104291 -0.9774953 -1.485942\n   nMoreExtreme size              leadingEdge\n1:           33    6                CD3E,NRGN\n2:           52    7             PTPRC,PECAM1\n3:           11    6 CD3E,CD3D,PTPRC,CD3G,CD4\n\n$`2`\n                           pathway         pval       padj        ES      NES\n1:                      Neutrophil 0.0001731902 0.01493486 0.9026856 2.000836\n2:          CD1C+_B dendritic cell 0.0001805706 0.01493486 0.9214031 1.927177\n3: Monocyte derived dendritic cell 0.0033797217 0.11876626 0.9201039 1.622366\n   nMoreExtreme size                                 leadingEdge\n1:            0   80 S100A8,S100A9,S100A12,MNDA,CD14,S100A11,...\n2:            0   53     S100A8,S100A9,LYZ,S100A12,VCAN,RETN,...\n3:           16   17     S100A8,S100A9,CD14,CST3,ITGAM,SIRPA,...\n\n$`3`\n             pathway         pval        padj        ES      NES nMoreExtreme\n1: Naive CD8+ T cell 0.0002281022 0.006126173 0.8565970 2.031114            0\n2: Naive CD4+ T cell 0.0002192982 0.006126173 0.9304436 1.890641            0\n3:       CD4+ T cell 0.0002177226 0.006126173 0.9208809 1.785800            0\n   size                            leadingEdge\n1:   91 LDHB,PIK3IP1,TCF7,NPM1,NOSIP,RCAN3,...\n2:   34    IL7R,RPS5,TCF7,EEF1B2,NOSIP,MAL,...\n3:   25        IL7R,LTB,CD3E,CD3D,CD3G,CD2,...\n\n$`4`\n                 pathway        pval       padj         ES       NES\n1:         Megakaryocyte 0.003571429 0.06714286  0.7665291  1.760066\n2:   Natural killer cell 0.006040749 0.09250079 -0.6819437 -1.313942\n3: CD4+ cytotoxic T cell 0.002148338 0.06155335 -0.6940304 -1.339496\n   nMoreExtreme size                             leadingEdge\n1:            2   26       PPBP,PF4,GP9,ITGA2B,CD9,GP1BA,...\n2:           58   84    PTPRC,CD69,CD81,FCGR3A,CD3E,IL7R,...\n3:           20   86 ZEB2,EFHD2,AHNAK,LITAF,FCGR3A,RUNX3,...\n\n$`5`\n            pathway         pval       padj        ES      NES nMoreExtreme\n1: Mesenchymal cell 0.0006540935 0.06148479 0.8257126 1.523605            5\n2:     Stromal cell 0.0023158870 0.08707735 0.8486543 1.509630           19\n3:    Hemangioblast 0.0004495055 0.06148479 0.9913801 1.477231            2\n   size                           leadingEdge\n1:   59   COTL1,S100A4,CTSC,HES4,ZEB2,VIM,...\n2:   38 PECAM1,TIMP1,VIM,CD44,ICAM3,TIMP2,...\n3:    7                           PECAM1,CD34\n\n$`6`\n                 pathway         pval       padj        ES      NES\n1: CD4+ cytotoxic T cell 0.0001880053 0.01005778 0.8631101 1.980546\n2:   Natural killer cell 0.0001885725 0.01005778 0.7731544 1.769060\n3:           CD8+ T cell 0.0003852080 0.01448382 0.9493335 1.733707\n   nMoreExtreme size                       leadingEdge\n1:            0   86 CCL5,NKG7,GZMH,GNLY,CST7,GZMA,...\n2:            0   84 NKG7,CD3D,GNLY,CD3E,GZMA,CD3G,...\n3:            1   19 NKG7,CD3D,CD3E,CD3G,CD8A,GZMK,...\n\n$`7`\n                  pathway         pval       padj        ES      NES\n1:             Neutrophil 0.0001128668 0.00794053 0.9062359 1.789269\n2: CD1C+_B dendritic cell 0.0001206418 0.00794053 0.9179018 1.742702\n3:           Stromal cell 0.0001267106 0.00794053 0.8920731 1.640280\n   nMoreExtreme size                                 leadingEdge\n1:            0   80 S100A8,S100A9,S100A11,CD14,S100A12,MNDA,...\n2:            0   53        S100A8,S100A9,LYZ,FCN1,VCAN,CD14,...\n3:            0   38         VIM,CD44,ICAM1,TIMP2,BST1,TIMP1,...\n\n$`8`\n                             pathway         pval        padj        ES\n1:             CD4+ cytotoxic T cell 0.0002646203 0.009949722 0.9419189\n2: Effector CD8+ memory T (Tem) cell 0.0002619859 0.009949722 0.8922914\n3:               Natural killer cell 0.0002638522 0.009949722 0.8422994\n        NES nMoreExtreme size                           leadingEdge\n1: 2.186984            0   86   GNLY,NKG7,GZMB,CCL5,FGFBP2,PRF1,...\n2: 2.053635            0   79 GNLY,GZMB,FGFBP2,KLRD1,GZMH,SPON2,...\n3: 1.952367            0   84   GNLY,NKG7,GZMB,GZMA,CD247,KLRD1,...\n```\n:::\n:::\n\n\n#CT_GSEA8:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnew.cluster.ids <- unlist(lapply(res, function(x) {\n    as.data.frame(x)[1, 1]\n}))\nalldata@colData$cellmarker_gsea <- new.cluster.ids[as.character(alldata@colData$louvain_SNNk15)]\n\ncowplot::plot_grid(\n    ncol = 2,\n    plotReducedDim(alldata, dimred = \"UMAP\", colour_by = \"cellmarker_gsea\"),\n    plotReducedDim(alldata, dimred = \"UMAP\", colour_by = \"ref_gsea\")\n)\n```\n\n::: {.cell-output-display}\n![](bioc_06_celltyping_files/figure-html/unnamed-chunk-36-1.png){width=960}\n:::\n:::\n\n\n:::{.callout-note title=\"Discuss\"}\n\n{{< meta ct_gsea_annot_2 >}}\n\n\n:::\n\n\n{{< meta ct_gsea_annot_3 >}}\n\n\n{{< meta ct_save >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(ctrl.sce,\"data/results/ctrl13_qc_dr_int_cl_celltype.rds\")\n```\n:::\n\n\n## {{< meta session >}}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.2.3 (2023-03-15)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.2 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3\nLAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] fgsea_1.24.0                caret_6.0-94               \n [3] lattice_0.20-45             SeuratObject_4.1.3         \n [5] Seurat_4.3.0.1              scmap_1.20.2               \n [7] scPred_1.9.2                rafalib_1.0.0              \n [9] pheatmap_1.0.12             cowplot_1.1.1              \n[11] dplyr_1.1.1                 scran_1.26.2               \n[13] scater_1.26.1               ggplot2_3.4.2              \n[15] scuttle_1.8.4               SingleCellExperiment_1.20.1\n[17] SummarizedExperiment_1.28.0 Biobase_2.58.0             \n[19] GenomicRanges_1.50.2        GenomeInfoDb_1.34.9        \n[21] IRanges_2.32.0              S4Vectors_0.36.2           \n[23] BiocGenerics_0.44.0         MatrixGenerics_1.10.0      \n[25] matrixStats_1.0.0          \n\nloaded via a namespace (and not attached):\n  [1] utf8_1.2.3                spatstat.explore_3.2-1   \n  [3] reticulate_1.30           tidyselect_1.2.0         \n  [5] htmlwidgets_1.6.2         grid_4.2.3               \n  [7] BiocParallel_1.32.6       Rtsne_0.16               \n  [9] pROC_1.18.5               munsell_0.5.0            \n [11] ScaledMatrix_1.6.0        codetools_0.2-19         \n [13] ica_1.0-3                 statmod_1.5.0            \n [15] future_1.33.0             miniUI_0.1.1.1           \n [17] withr_2.5.0               spatstat.random_3.1-5    \n [19] colorspace_2.1-0          progressr_0.13.0         \n [21] knitr_1.43                rstudioapi_0.14          \n [23] ROCR_1.0-11               tensor_1.5               \n [25] listenv_0.9.0             labeling_0.4.2           \n [27] GenomeInfoDbData_1.2.9    harmony_0.1.1            \n [29] polyclip_1.10-4           farver_2.1.1             \n [31] parallelly_1.36.0         vctrs_0.6.3              \n [33] generics_0.1.3            ipred_0.9-14             \n [35] xfun_0.39                 timechange_0.2.0         \n [37] randomForest_4.7-1.1      R6_2.5.1                 \n [39] ggbeeswarm_0.7.2          rsvd_1.0.5               \n [41] locfit_1.5-9.8            bitops_1.0-7             \n [43] spatstat.utils_3.0-3      DelayedArray_0.24.0      \n [45] promises_1.2.0.1          scales_1.2.1             \n [47] nnet_7.3-18               beeswarm_0.4.0           \n [49] gtable_0.3.3              beachmat_2.14.2          \n [51] globals_0.16.2            goftest_1.2-3            \n [53] timeDate_4022.108         rlang_1.1.1              \n [55] splines_4.2.3             lazyeval_0.2.2           \n [57] ModelMetrics_1.2.2.2      spatstat.geom_3.2-1      \n [59] yaml_2.3.7                reshape2_1.4.4           \n [61] abind_1.4-5               httpuv_1.6.11            \n [63] tools_4.2.3               lava_1.7.2.1             \n [65] ellipsis_0.3.2            RColorBrewer_1.1-3       \n [67] proxy_0.4-27              ggridges_0.5.4           \n [69] Rcpp_1.0.10               plyr_1.8.8               \n [71] sparseMatrixStats_1.10.0  zlibbioc_1.44.0          \n [73] purrr_1.0.1               RCurl_1.98-1.12          \n [75] deldir_1.0-9              rpart_4.1.19             \n [77] pbapply_1.7-2             viridis_0.6.3            \n [79] zoo_1.8-12                ggrepel_0.9.3            \n [81] cluster_2.1.4             magrittr_2.0.3           \n [83] data.table_1.14.8         scattermore_1.2          \n [85] lmtest_0.9-40             RANN_2.6.1               \n [87] fitdistrplus_1.1-11       patchwork_1.1.2          \n [89] mime_0.12                 evaluate_0.21            \n [91] xtable_1.8-4              gridExtra_2.3            \n [93] compiler_4.2.3            tibble_3.2.1             \n [95] crayon_1.5.2              KernSmooth_2.23-20       \n [97] htmltools_0.5.5           later_1.3.1              \n [99] tidyr_1.3.0               lubridate_1.9.2          \n[101] MASS_7.3-58.2             Matrix_1.6-0             \n[103] cli_3.6.1                 parallel_4.2.3           \n[105] metapod_1.6.0             gower_1.0.1              \n[107] igraph_1.5.0              pkgconfig_2.0.3          \n[109] sp_2.0-0                  plotly_4.10.2            \n[111] spatstat.sparse_3.0-2     recipes_1.0.6            \n[113] foreach_1.5.2             vipor_0.4.5              \n[115] hardhat_1.3.0             dqrng_0.3.0              \n[117] XVector_0.38.0            prodlim_2023.03.31       \n[119] stringr_1.5.0             digest_0.6.33            \n[121] sctransform_0.3.5         RcppAnnoy_0.0.21         \n[123] spatstat.data_3.0-1       fastmatch_1.1-3          \n[125] rmarkdown_2.21            leiden_0.4.3             \n[127] uwot_0.1.16               edgeR_3.40.2             \n[129] DelayedMatrixStats_1.20.0 googleVis_0.7.1          \n[131] kernlab_0.9-32            shiny_1.7.4              \n[133] lifecycle_1.0.3           nlme_3.1-162             \n[135] jsonlite_1.8.7            BiocNeighbors_1.16.0     \n[137] viridisLite_0.4.2         limma_3.54.2             \n[139] fansi_1.0.4               pillar_1.9.0             \n[141] fastmap_1.1.1             httr_1.4.6               \n[143] survival_3.5-3            glue_1.6.2               \n[145] FNN_1.1.3.2               png_0.1-8                \n[147] iterators_1.0.14          bluster_1.8.0            \n[149] class_7.3-21              stringi_1.7.12           \n[151] BiocSingular_1.14.0       irlba_2.3.5.1            \n[153] e1071_1.7-13              future.apply_1.11.0      \n```\n:::\n:::\n",
    "supporting": [
      "bioc_06_celltyping_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}