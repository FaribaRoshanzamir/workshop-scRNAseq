---
author: "Åsa Björklund  &  Paulo Czarnewski"
date: 'November 30, 2020'
output:
  html_document:
    self_contained: true
    highlight: tango
    df_print: paged
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    keep_md: yes
    fig_caption: true
  html_notebook:
    self_contained: true
    highlight: tango
    df_print: paged
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
---


<style>
h1, .h1, h2, .h2, h3, .h3, h4, .h4 { margin-top: 50px }
p.caption {font-size: 0.9em;font-style: italic;color: grey;margin-right: 10%;margin-left: 10%;text-align: justify}
</style>

# Differential gene expression

In this tutorial we will cover about Differetial gene expression, which comprises an extensive range of topics and methods. In single cell, differential expresison can have multiple functionalities such as of identifying marker genes for cell populations, as well as differentially regulated genes across conditions (healthy vs control). We will also exercise on how to account the batch information in your test.

We can first load the data from the clustering session. Moreover, we can already decide which clustering resolution to use. First let's define using the `louvain` clustering to identifying differentially expressed genes.  


```r
suppressPackageStartupMessages({
    library(Seurat)
    library(venn)
    library(dplyr)
    library(cowplot)
    library(ggplot2)
    library(pheatmap)
    library(rafalib)
})

alldata <- readRDS("data/results/covid_qc_dr_int_cl.rds")
```


```r
# Set the identity as louvain with resolution 0.3
sel.clust = "CCA_snn_res.0.3"

alldata <- SetIdent(alldata, value = sel.clust)
table(alldata@active.ident)
```

```
## 
##    0    1    2    3    4    5    6    7 
## 1455 1020  871  679  570  483  240  214
```

```r
# plot this clustering
plot_grid(ncol = 3, DimPlot(alldata, label = T) + NoAxes(), DimPlot(alldata, group.by = "orig.ident") + 
    NoAxes(), DimPlot(alldata, group.by = "type") + NoAxes())
```

![](seurat_05_dge_files/figure-html/unnamed-chunk-2-1.png)<!-- -->

## Cell marker genes
***

Let us first compute a ranking for the highly differential genes in each cluster. There are many different tests and parameters to be chosen that can be used to refine your results. When looking for marker genes, we want genes that are positivelly expressed in a cell type and possibly not expressed in the others.


```r
# Compute differentiall expression
markers_genes <- FindAllMarkers(alldata, logfc.threshold = 0.2, test.use = "wilcox", 
    min.pct = 0.1, min.diff.pct = 0.2, only.pos = TRUE, max.cells.per.ident = 50, 
    assay = "RNA")
```

We can now select the top 25 up regulated genes for plotting.


```r
top25 <- markers_genes %>% group_by(cluster) %>% top_n(-25, p_val_adj)
top25
```

<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":["p_val"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["avg_logFC"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["pct.1"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["pct.2"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["p_val_adj"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["cluster"],"name":[6],"type":["fct"],"align":["left"]},{"label":["gene"],"name":[7],"type":["chr"],"align":["left"]}],"data":[{"1":"2.142810e-19","2":"1.9090941","3":"0.938","4":"0.058","5":"3.882986e-15","6":"0","7":"CD14"},{"1":"1.656376e-18","2":"2.2007798","3":"0.964","4":"0.071","5":"3.001520e-14","6":"0","7":"VCAN"},{"1":"5.107220e-17","2":"2.5205764","3":"1.000","4":"0.259","5":"9.254793e-13","6":"0","7":"LYZ"},{"1":"9.966179e-17","2":"2.1121098","3":"0.984","4":"0.121","5":"1.805971e-12","6":"0","7":"AC020656.1"},{"1":"1.687929e-16","2":"2.0257291","3":"0.994","4":"0.134","5":"3.058696e-12","6":"0","7":"FCN1"},{"1":"3.902327e-16","2":"2.7804826","3":"0.997","4":"0.343","5":"7.071407e-12","6":"0","7":"S100A9"},{"1":"4.126171e-16","2":"2.8584449","3":"0.992","4":"0.257","5":"7.477035e-12","6":"0","7":"S100A8"},{"1":"4.126171e-16","2":"1.4260807","3":"0.971","4":"0.336","5":"7.477035e-12","6":"0","7":"APLP2"},{"1":"1.239329e-15","2":"2.3355674","3":"0.939","4":"0.068","5":"2.245789e-11","6":"0","7":"S100A12"},{"1":"1.426581e-15","2":"1.5646526","3":"0.931","4":"0.063","5":"2.585107e-11","6":"0","7":"MS4A6A"},{"1":"1.473930e-15","2":"1.3860774","3":"0.926","4":"0.087","5":"2.670909e-11","6":"0","7":"CSF3R"},{"1":"3.725118e-15","2":"1.2846044","3":"0.886","4":"0.084","5":"6.750287e-11","6":"0","7":"TNFSF13B"},{"1":"4.163636e-15","2":"1.3477835","3":"0.927","4":"0.173","5":"7.544926e-11","6":"0","7":"CEBPD"},{"1":"7.656730e-15","2":"1.5716916","3":"0.856","4":"0.065","5":"1.387476e-10","6":"0","7":"PLBD1"},{"1":"1.076268e-14","2":"1.8372728","3":"0.966","4":"0.111","5":"1.950306e-10","6":"0","7":"MNDA"},{"1":"1.125789e-14","2":"1.3329973","3":"0.867","4":"0.091","5":"2.040042e-10","6":"0","7":"SLC11A1"},{"1":"1.138794e-14","2":"1.2714221","3":"0.884","4":"0.097","5":"2.063608e-10","6":"0","7":"MPEG1"},{"1":"1.139599e-14","2":"1.3502580","3":"0.916","4":"0.138","5":"2.065067e-10","6":"0","7":"FGL2"},{"1":"3.980438e-14","2":"1.3167825","3":"0.849","4":"0.057","5":"7.212952e-10","6":"0","7":"FPR1"},{"1":"6.315995e-14","2":"1.1951340","3":"0.986","4":"0.563","5":"1.144522e-09","6":"0","7":"TSPO"},{"1":"6.687220e-14","2":"1.6011463","3":"0.980","4":"0.296","5":"1.211791e-09","6":"0","7":"TYMP"},{"1":"6.693803e-14","2":"1.6351589","3":"0.967","4":"0.174","5":"1.212984e-09","6":"0","7":"GRN"},{"1":"7.419046e-14","2":"1.6340813","3":"0.827","4":"0.103","5":"1.344405e-09","6":"0","7":"DUSP6"},{"1":"8.274594e-14","2":"1.4895175","3":"0.991","4":"0.460","5":"1.499439e-09","6":"0","7":"S100A11"},{"1":"8.286810e-14","2":"1.6917631","3":"0.942","4":"0.242","5":"1.501653e-09","6":"0","7":"NAMPT"},{"1":"1.941038e-16","2":"1.3563174","3":"0.992","4":"0.388","5":"3.517355e-12","6":"1","7":"CCL5"},{"1":"8.960694e-14","2":"1.1778997","3":"0.952","4":"0.272","5":"1.623767e-09","6":"1","7":"CD3E"},{"1":"1.091913e-12","2":"1.2031372","3":"0.984","4":"0.324","5":"1.978656e-08","6":"1","7":"IL32"},{"1":"1.459636e-12","2":"1.0817845","3":"0.627","4":"0.074","5":"2.645006e-08","6":"1","7":"KLRG1"},{"1":"4.379396e-12","2":"1.3588882","3":"0.835","4":"0.190","5":"7.935904e-08","6":"1","7":"GZMH"},{"1":"1.433204e-11","2":"1.1792037","3":"0.585","4":"0.057","5":"2.597109e-07","6":"1","7":"TRGC2"},{"1":"4.071452e-11","2":"0.8502230","3":"0.956","4":"0.295","5":"7.377879e-07","6":"1","7":"CST7"},{"1":"4.555648e-11","2":"1.4563773","3":"0.934","4":"0.186","5":"8.255289e-07","6":"1","7":"CD3D"},{"1":"4.944568e-11","2":"0.7530896","3":"0.908","4":"0.614","5":"8.960052e-07","6":"1","7":"PPP2R5C"},{"1":"3.499972e-10","2":"0.9375240","3":"0.984","4":"0.394","5":"6.342300e-06","6":"1","7":"NKG7"},{"1":"6.289052e-10","2":"0.6326073","3":"0.850","4":"0.257","5":"1.139639e-05","6":"1","7":"CTSW"},{"1":"1.371253e-09","2":"1.1261688","3":"0.786","4":"0.240","5":"2.484847e-05","6":"1","7":"LYAR"},{"1":"1.420693e-09","2":"1.3214183","3":"0.859","4":"0.162","5":"2.574437e-05","6":"1","7":"CD3G"},{"1":"2.492117e-09","2":"0.9180853","3":"0.909","4":"0.230","5":"4.515966e-05","6":"1","7":"GZMA"},{"1":"3.157900e-09","2":"0.6350126","3":"0.392","4":"0.115","5":"5.722431e-05","6":"1","7":"PTMS"},{"1":"3.332455e-09","2":"0.7982593","3":"0.750","4":"0.244","5":"6.038741e-05","6":"1","7":"C12orf75"},{"1":"4.855411e-09","2":"0.8101086","3":"0.926","4":"0.465","5":"8.798490e-05","6":"1","7":"ARL4C"},{"1":"6.625149e-09","2":"0.8167074","3":"0.757","4":"0.474","5":"1.200543e-04","6":"1","7":"PIK3R1"},{"1":"1.373762e-08","2":"0.8612511","3":"0.721","4":"0.240","5":"2.489394e-04","6":"1","7":"SPOCK2"},{"1":"1.480693e-08","2":"0.5656230","3":"0.555","4":"0.158","5":"2.683164e-04","6":"1","7":"MATK"},{"1":"1.999965e-08","2":"0.8483534","3":"0.782","4":"0.272","5":"3.624136e-04","6":"1","7":"RORA"},{"1":"3.603445e-08","2":"1.0358316","3":"0.778","4":"0.328","5":"6.529802e-04","6":"1","7":"DUSP2"},{"1":"3.763704e-08","2":"0.9384254","3":"0.892","4":"0.257","5":"6.820207e-04","6":"1","7":"GZMM"},{"1":"5.293027e-08","2":"1.5206916","3":"0.560","4":"0.070","5":"9.591494e-04","6":"1","7":"CD8A"},{"1":"7.244556e-08","2":"0.5495765","3":"0.606","4":"0.203","5":"1.312786e-03","6":"1","7":"KLRD1"},{"1":"2.744707e-18","2":"1.6174261","3":"0.917","4":"0.157","5":"4.973683e-14","6":"2","7":"KLRD1"},{"1":"1.753292e-15","2":"2.4192508","3":"0.953","4":"0.240","5":"3.177141e-11","6":"2","7":"GNLY"},{"1":"4.591607e-15","2":"2.1527200","3":"0.975","4":"0.179","5":"8.320451e-11","6":"2","7":"GZMB"},{"1":"4.658316e-15","2":"1.8041915","3":"0.972","4":"0.253","5":"8.441334e-11","6":"2","7":"CTSW"},{"1":"5.190298e-15","2":"1.4279004","3":"0.746","4":"0.057","5":"9.405338e-11","6":"2","7":"TRDC"},{"1":"6.185010e-15","2":"1.9091410","3":"0.999","4":"0.410","5":"1.120786e-10","6":"2","7":"NKG7"},{"1":"1.082382e-14","2":"1.6941801","3":"0.946","4":"0.271","5":"1.961384e-10","6":"2","7":"CD247"},{"1":"2.794141e-14","2":"2.0996687","3":"0.946","4":"0.194","5":"5.063263e-10","6":"2","7":"PRF1"},{"1":"3.755813e-14","2":"1.9459929","3":"0.758","4":"0.107","5":"6.805909e-10","6":"2","7":"SPON2"},{"1":"1.000570e-13","2":"1.7101419","3":"0.783","4":"0.040","5":"1.813133e-09","6":"2","7":"KLRF1"},{"1":"1.664901e-13","2":"1.2126839","3":"0.851","4":"0.198","5":"3.016967e-09","6":"2","7":"FCGR3A"},{"1":"2.769209e-13","2":"1.6650898","3":"0.979","4":"0.312","5":"5.018085e-09","6":"2","7":"CST7"},{"1":"3.043033e-13","2":"2.0118645","3":"0.897","4":"0.166","5":"5.514279e-09","6":"2","7":"FGFBP2"},{"1":"3.381137e-13","2":"1.1250298","3":"0.956","4":"0.474","5":"6.126958e-09","6":"2","7":"ARL4C"},{"1":"4.703989e-13","2":"1.5023627","3":"0.931","4":"0.247","5":"8.524099e-09","6":"2","7":"GZMA"},{"1":"1.030106e-12","2":"1.2561786","3":"0.898","4":"0.276","5":"1.866655e-08","6":"2","7":"GZMM"},{"1":"3.356833e-12","2":"1.1420570","3":"0.892","4":"0.533","5":"6.082916e-08","6":"2","7":"ABHD17A"},{"1":"6.370472e-12","2":"1.0922443","3":"0.749","4":"0.266","5":"1.154393e-07","6":"2","7":"APMAP"},{"1":"1.385067e-10","2":"1.4033885","3":"0.858","4":"0.215","5":"2.509879e-06","6":"2","7":"HOPX"},{"1":"1.645103e-10","2":"1.4772715","3":"0.825","4":"0.274","5":"2.981092e-06","6":"2","7":"CD7"},{"1":"1.159950e-09","2":"1.5605418","3":"0.682","4":"0.072","5":"2.101946e-05","6":"2","7":"CLIC3"},{"1":"1.983006e-09","2":"1.0235360","3":"0.584","4":"0.106","5":"3.593405e-05","6":"2","7":"CEP78"},{"1":"4.537546e-09","2":"1.2656300","3":"0.863","4":"0.206","5":"8.222486e-05","6":"2","7":"GZMH"},{"1":"4.703429e-09","2":"1.0476349","3":"0.565","4":"0.076","5":"8.523085e-05","6":"2","7":"TXK"},{"1":"1.059525e-08","2":"1.3732051","3":"0.457","4":"0.035","5":"1.919965e-04","6":"2","7":"MYOM2"},{"1":"3.769734e-16","2":"1.6653903","3":"0.947","4":"0.160","5":"6.831135e-12","6":"3","7":"IL7R"},{"1":"3.702165e-13","2":"1.0304591","3":"0.710","4":"0.163","5":"6.708693e-09","6":"3","7":"TCF7"},{"1":"7.740899e-12","2":"1.1787470","3":"0.919","4":"0.513","5":"1.402728e-07","6":"3","7":"LDHB"},{"1":"4.177387e-11","2":"1.4980609","3":"0.954","4":"0.333","5":"7.569843e-07","6":"3","7":"LTB"},{"1":"3.112002e-10","2":"1.0651391","3":"0.829","4":"0.195","5":"5.639258e-06","6":"3","7":"TRAC"},{"1":"9.105382e-10","2":"0.9983530","3":"0.890","4":"0.365","5":"1.649986e-05","6":"3","7":"PIK3IP1"},{"1":"1.122157e-09","2":"0.9536731","3":"0.513","4":"0.010","5":"2.033461e-05","6":"3","7":"MAL"},{"1":"3.309271e-09","2":"0.9881594","3":"0.872","4":"0.446","5":"5.996730e-05","6":"3","7":"LEPROTL1"},{"1":"3.499847e-09","2":"0.7439788","3":"0.753","4":"0.346","5":"6.342073e-05","6":"3","7":"GIMAP7"},{"1":"6.410917e-09","2":"0.8085209","3":"0.433","4":"0.028","5":"1.161722e-04","6":"3","7":"LEF1"},{"1":"3.951143e-08","2":"0.6925829","3":"0.432","4":"0.087","5":"7.159867e-04","6":"3","7":"PRKCA"},{"1":"1.282925e-07","2":"0.5780972","3":"0.848","4":"0.251","5":"2.324789e-03","6":"3","7":"CD3D"},{"1":"1.734336e-07","2":"0.5784305","3":"0.390","4":"0.042","5":"3.142791e-03","6":"3","7":"TRAT1"},{"1":"1.734336e-07","2":"0.4740585","3":"0.305","4":"0.070","5":"3.142791e-03","6":"3","7":"FAM102A"},{"1":"2.031315e-07","2":"0.6565508","3":"0.426","4":"0.136","5":"3.680945e-03","6":"3","7":"GATA3"},{"1":"3.398836e-07","2":"0.5474091","3":"0.365","4":"0.053","5":"6.159031e-03","6":"3","7":"CD27"},{"1":"5.653388e-07","2":"0.6582700","3":"0.932","4":"0.323","5":"1.024450e-02","6":"3","7":"CD3E"},{"1":"6.155460e-07","2":"0.4848134","3":"0.689","4":"0.403","5":"1.115431e-02","6":"3","7":"MZT2A"},{"1":"6.296128e-07","2":"0.6265441","3":"0.483","4":"0.130","5":"1.140921e-02","6":"3","7":"SFXN1"},{"1":"1.652206e-06","2":"0.8354412","3":"0.795","4":"0.371","5":"2.993962e-02","6":"3","7":"TRBC2"},{"1":"1.892934e-06","2":"0.7111027","3":"0.362","4":"0.026","5":"3.430185e-02","6":"3","7":"TRABD2A"},{"1":"4.604878e-06","2":"0.3760352","3":"0.574","4":"0.275","5":"8.344500e-02","6":"3","7":"PRDX2"},{"1":"4.741455e-06","2":"0.3255513","3":"0.703","4":"0.493","5":"8.591991e-02","6":"3","7":"RSL1D1"},{"1":"5.458681e-06","2":"0.5965243","3":"0.462","4":"0.112","5":"9.891676e-02","6":"3","7":"BCL11B"},{"1":"5.793538e-06","2":"0.5446271","3":"0.705","4":"0.276","5":"1.049847e-01","6":"3","7":"SPOCK2"},{"1":"6.632718e-20","2":"2.9546474","3":"0.991","4":"0.062","5":"1.201915e-15","6":"4","7":"IGHM"},{"1":"1.259346e-19","2":"2.4500520","3":"0.949","4":"0.027","5":"2.282062e-15","6":"4","7":"IGHD"},{"1":"2.031693e-19","2":"2.2719182","3":"0.974","4":"0.070","5":"3.681631e-15","6":"4","7":"CD79A"},{"1":"4.901163e-18","2":"1.7015453","3":"0.895","4":"0.066","5":"8.881397e-14","6":"4","7":"TNFRSF13C"},{"1":"5.950247e-18","2":"1.7214800","3":"0.905","4":"0.064","5":"1.078244e-13","6":"4","7":"MS4A1"},{"1":"1.542726e-16","2":"1.7750628","3":"0.882","4":"0.060","5":"2.795574e-12","6":"4","7":"LINC00926"},{"1":"2.117471e-16","2":"1.3787907","3":"0.975","4":"0.527","5":"3.837070e-12","6":"4","7":"HLA-DQB1"},{"1":"3.158027e-16","2":"1.3178841","3":"0.991","4":"0.620","5":"5.722661e-12","6":"4","7":"HLA-DRA"},{"1":"2.013052e-15","2":"1.1125101","3":"0.974","4":"0.670","5":"3.647851e-11","6":"4","7":"HLA-DPB1"},{"1":"4.746887e-15","2":"1.4810717","3":"0.835","4":"0.066","5":"8.601835e-11","6":"4","7":"BANK1"},{"1":"5.536396e-15","2":"1.7127405","3":"0.877","4":"0.140","5":"1.003250e-10","6":"4","7":"CD79B"},{"1":"2.159618e-14","2":"1.2923838","3":"0.649","4":"0.027","5":"3.913443e-10","6":"4","7":"FCER2"},{"1":"6.382826e-14","2":"1.7904662","3":"0.746","4":"0.009","5":"1.156632e-09","6":"4","7":"TCL1A"},{"1":"1.258235e-13","2":"1.6587946","3":"0.884","4":"0.287","5":"2.280047e-09","6":"4","7":"CD83"},{"1":"1.612459e-13","2":"0.8754042","3":"0.970","4":"0.686","5":"2.921937e-09","6":"4","7":"HLA-DPA1"},{"1":"3.952225e-13","2":"1.0558478","3":"0.989","4":"0.710","5":"7.161827e-09","6":"4","7":"HLA-DRB1"},{"1":"3.152451e-12","2":"1.2856359","3":"0.833","4":"0.343","5":"5.712557e-08","6":"4","7":"YBX3"},{"1":"9.162173e-12","2":"0.9991398","3":"0.879","4":"0.307","5":"1.660277e-07","6":"4","7":"HLA-DQA1"},{"1":"2.805533e-11","2":"1.1491683","3":"0.604","4":"0.027","5":"5.083907e-07","6":"4","7":"FAM129C"},{"1":"4.016798e-11","2":"1.4255652","3":"0.737","4":"0.075","5":"7.278839e-07","6":"4","7":"RALGPS2"},{"1":"6.668123e-11","2":"0.9795466","3":"0.775","4":"0.301","5":"1.208331e-06","6":"4","7":"HLA-DMB"},{"1":"1.813058e-10","2":"1.0872552","3":"0.609","4":"0.118","5":"3.285442e-06","6":"4","7":"BCL11A"},{"1":"1.900234e-10","2":"1.0896237","3":"0.616","4":"0.100","5":"3.443414e-06","6":"4","7":"PLPP5"},{"1":"2.155888e-10","2":"1.2337406","3":"0.693","4":"0.043","5":"3.906685e-06","6":"4","7":"AFF3"},{"1":"9.414773e-10","2":"1.1632938","3":"0.970","4":"0.636","5":"1.706051e-05","6":"4","7":"CXCR4"},{"1":"1.441265e-06","2":"0.5662099","3":"0.230","4":"0.465","5":"2.611716e-02","6":"5","7":"CRBN"},{"1":"1.296089e-05","2":"0.5985104","3":"0.306","4":"0.524","5":"2.348643e-01","6":"5","7":"DYNLRB1"},{"1":"2.710394e-05","2":"0.2042922","3":"0.228","4":"0.557","5":"4.911506e-01","6":"5","7":"BUD31"},{"1":"5.272907e-05","2":"0.2086482","3":"0.251","4":"0.514","5":"9.555035e-01","6":"5","7":"REEP5"},{"1":"5.507909e-05","2":"0.4165576","3":"0.271","4":"0.559","5":"9.980883e-01","6":"5","7":"UBE2B"},{"1":"6.598199e-05","2":"0.3018868","3":"0.244","4":"0.470","5":"1.000000e+00","6":"5","7":"PSMA4"},{"1":"1.142105e-04","2":"1.6546791","3":"0.282","4":"0.063","5":"1.000000e+00","6":"5","7":"TUBB1"},{"1":"2.180189e-04","2":"0.2395402","3":"0.420","4":"0.773","5":"1.000000e+00","6":"5","7":"TMBIM6"},{"1":"2.829464e-04","2":"0.2291385","3":"0.325","4":"0.682","5":"1.000000e+00","6":"5","7":"ATP5MC3"},{"1":"3.028831e-04","2":"0.3837991","3":"0.288","4":"0.585","5":"1.000000e+00","6":"5","7":"NDUFB4"},{"1":"4.696743e-04","2":"0.2028097","3":"0.317","4":"0.579","5":"1.000000e+00","6":"5","7":"CAPNS1"},{"1":"5.666031e-04","2":"0.2561255","3":"0.337","4":"0.718","5":"1.000000e+00","6":"5","7":"POMP"},{"1":"5.795854e-04","2":"0.5036220","3":"0.308","4":"0.539","5":"1.000000e+00","6":"5","7":"GABARAPL2"},{"1":"7.235417e-04","2":"0.7279480","3":"0.304","4":"0.620","5":"1.000000e+00","6":"5","7":"EIF1B"},{"1":"8.492835e-04","2":"0.2096120","3":"0.248","4":"0.506","5":"1.000000e+00","6":"5","7":"BSG"},{"1":"1.040312e-03","2":"0.2680910","3":"0.313","4":"0.627","5":"1.000000e+00","6":"5","7":"ATP5PF"},{"1":"1.231037e-03","2":"0.5719896","3":"0.354","4":"0.658","5":"1.000000e+00","6":"5","7":"C9orf16"},{"1":"1.246938e-03","2":"0.2103095","3":"0.228","4":"0.453","5":"1.000000e+00","6":"5","7":"ZNHIT1"},{"1":"1.248713e-03","2":"0.2727827","3":"0.201","4":"0.403","5":"1.000000e+00","6":"5","7":"ECH1"},{"1":"1.375591e-03","2":"0.3114934","3":"0.371","4":"0.691","5":"1.000000e+00","6":"5","7":"ARPC4"},{"1":"1.504909e-03","2":"0.3036996","3":"0.333","4":"0.637","5":"1.000000e+00","6":"5","7":"WDR83OS"},{"1":"1.650649e-03","2":"0.3569624","3":"0.313","4":"0.667","5":"1.000000e+00","6":"5","7":"PAIP2"},{"1":"2.290253e-03","2":"1.7038720","3":"0.327","4":"0.096","5":"1.000000e+00","6":"5","7":"CAVIN2"},{"1":"2.373662e-03","2":"0.2430301","3":"0.302","4":"0.539","5":"1.000000e+00","6":"5","7":"RTN4"},{"1":"2.379438e-03","2":"0.3896594","3":"0.234","4":"0.437","5":"1.000000e+00","6":"5","7":"BNIP3L"},{"1":"3.421557e-03","2":"0.2817698","3":"0.244","4":"0.497","5":"1.000000e+00","6":"5","7":"SRP9"},{"1":"3.756551e-03","2":"0.2121764","3":"0.275","4":"0.700","5":"1.000000e+00","6":"5","7":"RAN"},{"1":"4.043687e-03","2":"0.2081457","3":"0.207","4":"0.416","5":"1.000000e+00","6":"5","7":"PSMB2"},{"1":"4.235699e-03","2":"0.3657635","3":"0.215","4":"0.445","5":"1.000000e+00","6":"5","7":"PFDN2"},{"1":"4.338824e-03","2":"0.2087878","3":"0.277","4":"0.508","5":"1.000000e+00","6":"5","7":"ANP32A"},{"1":"4.456417e-03","2":"1.8185204","3":"0.321","4":"0.098","5":"1.000000e+00","6":"5","7":"GNG11"},{"1":"4.944979e-03","2":"0.2026302","3":"0.242","4":"0.470","5":"1.000000e+00","6":"5","7":"DBNL"},{"1":"5.591477e-03","2":"0.3151594","3":"0.317","4":"0.626","5":"1.000000e+00","6":"5","7":"RABAC1"},{"1":"6.562161e-03","2":"0.2160339","3":"0.273","4":"0.584","5":"1.000000e+00","6":"5","7":"UBE2L3"},{"1":"6.910713e-03","2":"0.2350998","3":"0.201","4":"0.434","5":"1.000000e+00","6":"5","7":"UBE2M"},{"1":"7.091878e-03","2":"0.2729474","3":"0.195","4":"0.402","5":"1.000000e+00","6":"5","7":"PSMA5"},{"1":"7.613066e-03","2":"0.2421373","3":"0.280","4":"0.558","5":"1.000000e+00","6":"5","7":"ATP5PB"},{"1":"7.621571e-03","2":"0.4237808","3":"0.391","4":"0.733","5":"1.000000e+00","6":"5","7":"SRSF3"},{"1":"8.652618e-03","2":"0.2183689","3":"0.217","4":"0.430","5":"1.000000e+00","6":"5","7":"SNF8"},{"1":"8.660264e-03","2":"0.2995199","3":"0.292","4":"0.517","5":"1.000000e+00","6":"5","7":"GDI2"},{"1":"8.779778e-03","2":"2.9379693","3":"0.416","4":"0.166","5":"1.000000e+00","6":"5","7":"PF4"},{"1":"1.352415e-14","2":"1.8275177","3":"0.996","4":"0.126","5":"2.450711e-10","6":"6","7":"CD79A"},{"1":"1.983652e-13","2":"1.4982500","3":"0.950","4":"0.109","5":"3.594577e-09","6":"6","7":"BANK1"},{"1":"5.532203e-13","2":"1.2353348","3":"0.958","4":"0.339","5":"1.002491e-08","6":"6","7":"HLA-DQA1"},{"1":"6.426344e-13","2":"1.3113849","3":"0.917","4":"0.117","5":"1.164518e-08","6":"6","7":"TNFRSF13C"},{"1":"2.663000e-12","2":"1.0799191","3":"0.838","4":"0.111","5":"4.825622e-08","6":"6","7":"RALGPS2"},{"1":"5.046036e-12","2":"1.0777216","3":"0.979","4":"0.555","5":"9.143922e-08","6":"6","7":"HLA-DQB1"},{"1":"6.294161e-12","2":"1.6874483","3":"0.938","4":"0.115","5":"1.140565e-07","6":"6","7":"MS4A1"},{"1":"6.624514e-12","2":"1.1629396","3":"0.992","4":"0.643","5":"1.200428e-07","6":"6","7":"HLA-DRA"},{"1":"2.209840e-11","2":"0.4572927","3":"0.733","4":"0.172","5":"4.004452e-07","6":"6","7":"PDLIM1"},{"1":"7.788312e-11","2":"0.9765627","3":"0.838","4":"0.113","5":"1.411320e-06","6":"6","7":"LINC00926"},{"1":"1.472211e-10","2":"1.0191014","3":"0.725","4":"0.056","5":"2.667793e-06","6":"6","7":"BLK"},{"1":"1.641726e-10","2":"1.0942861","3":"0.988","4":"0.689","5":"2.974972e-06","6":"6","7":"HLA-DPB1"},{"1":"1.445552e-09","2":"0.9817753","3":"0.667","4":"0.090","5":"2.619485e-05","6":"6","7":"P2RX5"},{"1":"2.273296e-09","2":"0.9528166","3":"0.996","4":"0.703","5":"4.119441e-05","6":"6","7":"HLA-DPA1"},{"1":"2.535444e-09","2":"0.9540520","3":"0.708","4":"0.250","5":"4.594478e-05","6":"6","7":"NFKBID"},{"1":"2.914040e-09","2":"0.8156574","3":"0.571","4":"0.041","5":"5.280532e-05","6":"6","7":"POU2AF1"},{"1":"3.463759e-09","2":"1.5732144","3":"0.496","4":"0.117","5":"6.276677e-05","6":"6","7":"IGLC2"},{"1":"3.567641e-09","2":"0.9916143","3":"0.842","4":"0.188","5":"6.464922e-05","6":"6","7":"CD79B"},{"1":"4.317287e-09","2":"0.8827215","3":"0.592","4":"0.008","5":"7.823357e-05","6":"6","7":"TNFRSF13B"},{"1":"6.935648e-09","2":"2.0548170","3":"0.592","4":"0.101","5":"1.256809e-04","6":"6","7":"IGHA1"},{"1":"9.280014e-09","2":"0.9637311","3":"0.662","4":"0.044","5":"1.681631e-04","6":"6","7":"SPIB"},{"1":"1.077541e-08","2":"0.7183632","3":"0.583","4":"0.080","5":"1.952612e-04","6":"6","7":"GNG7"},{"1":"1.201636e-08","2":"0.8466217","3":"0.508","4":"0.038","5":"2.177485e-04","6":"6","7":"COBLL1"},{"1":"2.633930e-08","2":"0.6913822","3":"0.458","4":"0.034","5":"4.772944e-04","6":"6","7":"CD24"},{"1":"3.480275e-08","2":"1.0185126","3":"0.596","4":"0.042","5":"6.306606e-04","6":"6","7":"IGHG3"},{"1":"5.166080e-17","2":"1.3178755","3":"0.888","4":"0.109","5":"9.361454e-13","6":"7","7":"CSF1R"},{"1":"6.945318e-17","2":"2.2297259","3":"0.897","4":"0.038","5":"1.258561e-12","6":"7","7":"CDKN1C"},{"1":"1.108485e-16","2":"1.7777411","3":"0.972","4":"0.274","5":"2.008685e-12","6":"7","7":"FCGR3A"},{"1":"1.455822e-16","2":"2.1009023","3":"1.000","4":"0.385","5":"2.638095e-12","6":"7","7":"LST1"},{"1":"2.181689e-16","2":"1.6577065","3":"1.000","4":"0.369","5":"3.953438e-12","6":"7","7":"AIF1"},{"1":"2.447357e-16","2":"1.5591660","3":"0.916","4":"0.151","5":"4.434856e-12","6":"7","7":"MS4A7"},{"1":"2.805819e-16","2":"1.4893676","3":"0.953","4":"0.154","5":"5.084425e-12","6":"7","7":"SMIM25"},{"1":"4.191106e-16","2":"1.3564071","3":"1.000","4":"0.611","5":"7.594704e-12","6":"7","7":"PSAP"},{"1":"3.630726e-15","2":"1.2375511","3":"0.995","4":"0.386","5":"6.579239e-11","6":"7","7":"IFITM3"},{"1":"4.131939e-15","2":"1.6233437","3":"1.000","4":"0.643","5":"7.487488e-11","6":"7","7":"COTL1"},{"1":"5.536343e-15","2":"1.4029471","3":"1.000","4":"0.463","5":"1.003241e-10","6":"7","7":"FCER1G"},{"1":"6.901903e-15","2":"1.1599635","3":"0.986","4":"0.477","5":"1.250694e-10","6":"7","7":"NPC2"},{"1":"6.901903e-15","2":"1.0393688","3":"0.977","4":"0.463","5":"1.250694e-10","6":"7","7":"TNFRSF1B"},{"1":"7.118034e-15","2":"1.2638419","3":"0.949","4":"0.275","5":"1.289859e-10","6":"7","7":"WARS"},{"1":"7.452729e-15","2":"1.3742824","3":"0.944","4":"0.219","5":"1.350509e-10","6":"7","7":"LRRC25"},{"1":"3.873999e-14","2":"1.5171259","3":"0.991","4":"0.313","5":"7.020073e-10","6":"7","7":"SERPINA1"},{"1":"6.989373e-14","2":"1.1144101","3":"0.850","4":"0.106","5":"1.266544e-09","6":"7","7":"TCF7L2"},{"1":"1.724717e-13","2":"0.8752379","3":"0.939","4":"0.483","5":"3.125360e-09","6":"7","7":"MBD2"},{"1":"1.732963e-13","2":"1.0398181","3":"0.995","4":"0.584","5":"3.140301e-09","6":"7","7":"S100A11"},{"1":"5.861820e-13","2":"1.0900789","3":"0.743","4":"0.067","5":"1.062220e-08","6":"7","7":"HES4"},{"1":"6.018498e-13","2":"1.3420078","3":"0.986","4":"0.360","5":"1.090612e-08","6":"7","7":"SPI1"},{"1":"7.544469e-13","2":"1.0877313","3":"0.860","4":"0.172","5":"1.367133e-08","6":"7","7":"HMOX1"},{"1":"1.042063e-12","2":"0.8282628","3":"0.855","4":"0.238","5":"1.888323e-08","6":"7","7":"ITGAX"},{"1":"1.087646e-12","2":"1.3813686","3":"0.897","4":"0.293","5":"1.970923e-08","6":"7","7":"RHOC"},{"1":"1.099772e-12","2":"1.1880551","3":"0.907","4":"0.181","5":"1.992897e-08","6":"7","7":"RRAS"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>

We can now select the top 25 up regulated genes for plotting.


```r
mypar(1, 5, mar = c(4, 6, 3, 1))
for (i in unique(top25$cluster)) {
    barplot(sort(setNames(top25$avg_logFC, top25$gene)[top25$cluster == i], F), horiz = T, 
        las = 1, main = paste0(i, " vs. rest"), border = "white", yaxs = "i")
    abline(v = c(0, 0.25), lty = c(1, 2))
}
```

![](seurat_05_dge_files/figure-html/unnamed-chunk-5-1.png)<!-- -->![](seurat_05_dge_files/figure-html/unnamed-chunk-5-2.png)<!-- -->

We can visualize them as a heatmap. Here we are selecting the top 5.


```r
top5 <- markers_genes %>% group_by(cluster) %>% top_n(-5, p_val_adj)

# create a scale.data slot for the selected genes
alldata <- ScaleData(alldata, features = as.character(unique(top5$gene)), assay = "RNA")
DoHeatmap(alldata, features = as.character(unique(top5$gene)), group.by = sel.clust, 
    assay = "RNA")
```

![](seurat_05_dge_files/figure-html/unnamed-chunk-6-1.png)<!-- -->

Another way is by representing the overal group expression and detection rates in a dot-plot.


```r
DotPlot(alldata, features = as.character(unique(top5$gene)), group.by = sel.clust, 
    assay = "RNA") + coord_flip()
```

![](seurat_05_dge_files/figure-html/unnamed-chunk-7-1.png)<!-- -->

We can also plot a violin plot for each gene.


```r
# take top 3 genes per cluster/
top3 <- top5 %>% group_by(cluster) %>% top_n(-3, p_val_adj)


# set pt.size to zero if you do not want all the points to hide the violin
# shapes, or to a small value like 0.1
VlnPlot(alldata, features = as.character(unique(top3$gene)), ncol = 5, group.by = sel.clust, 
    assay = "RNA", pt.size = 0)
```

![](seurat_05_dge_files/figure-html/unnamed-chunk-8-1.png)<!-- -->

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 10px;}
</style>
<div class = "blue">
**Your turn**

Take a screen shot of those results and re-run the same code above with another test: "wilcox" (Wilcoxon Rank Sum test), "bimod" (Likelihood-ratio test), "roc" (Identifies 'markers' of gene expression using ROC analysis),"t" (Student's t-test),"negbinom" (negative binomial generalized linear model),"poisson" (poisson generalized linear model), "LR" (logistic regression), "MAST" (hurdle model), "DESeq2" (negative binomial distribution).
</div>

## Differential expression across conditions
***

The second way of computing differential expression is to answer which genes are differentially expressed within a cluster. For example, in our case we have libraries comming from patients and controls and we would like to know which genes are influenced the most in a particular cell type. 

For this end, we will first subset our data for the desired cell cluster, then change the cell identities to the variable of comparison (which now in our case is the "type", e.g. Covid/Ctrl).


```r
# select all cells in cluster 1
cell_selection <- subset(alldata, cells = colnames(alldata)[alldata@meta.data[, sel.clust] == 
    1])
cell_selection <- SetIdent(cell_selection, value = "type")
# Compute differentiall expression
DGE_cell_selection <- FindAllMarkers(cell_selection, logfc.threshold = 0.2, test.use = "wilcox", 
    min.pct = 0.1, min.diff.pct = 0.2, only.pos = TRUE, max.cells.per.ident = 50, 
    assay = "RNA")
```

We can now plot the expression across the "type".


```r
top5_cell_selection <- DGE_cell_selection %>% group_by(cluster) %>% top_n(-5, p_val_adj)

VlnPlot(cell_selection, features = as.character(unique(top5_cell_selection$gene)), 
    ncol = 5, group.by = "type", assay = "RNA", pt.size = 0.1)
```

![](seurat_05_dge_files/figure-html/unnamed-chunk-10-1.png)<!-- -->

We can also plot these genes across all clusters, but split by "type", to check if the genes are also up/downregulated in other celltypes.


```r
VlnPlot(alldata, features = as.character(unique(top5_cell_selection$gene)), ncol = 5, 
    split.by = "type", assay = "RNA", pt.size = 0)
```

![](seurat_05_dge_files/figure-html/unnamed-chunk-11-1.png)<!-- -->



Finally, lets save the integrated data for further analysis.


```r
saveRDS(alldata, "data/3pbmc_qc_dr_int_cl_dge.rds")
```


### Session Info
***


```r
sessionInfo()
```

```
## R version 4.0.3 (2020-10-10)
## Platform: x86_64-apple-darwin13.4.0 (64-bit)
## Running under: macOS Catalina 10.15.7
## 
## Matrix products: default
## BLAS/LAPACK: /Users/asbj/miniconda3/envs/scRNAseq2021/lib/libopenblasp-r0.3.12.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] rafalib_1.0.0   pheatmap_1.0.12 ggplot2_3.3.2   cowplot_1.1.0  
## [5] dplyr_1.0.2     venn_1.9        Seurat_3.2.2    RJSONIO_1.3-1.4
## [9] optparse_1.6.6 
## 
## loaded via a namespace (and not attached):
##   [1] Rtsne_0.15            colorspace_2.0-0      deldir_0.2-3         
##   [4] ellipsis_0.3.1        ggridges_0.5.2        spatstat.data_1.5-2  
##   [7] leiden_0.3.5          listenv_0.8.0         farver_2.0.3         
##  [10] getopt_1.20.3         ggrepel_0.8.2         codetools_0.2-18     
##  [13] splines_4.0.3         knitr_1.30            polyclip_1.10-0      
##  [16] jsonlite_1.7.1        ica_1.0-2             cluster_2.1.0        
##  [19] png_0.1-7             uwot_0.1.9            shiny_1.5.0          
##  [22] sctransform_0.3.1     compiler_4.0.3        httr_1.4.2           
##  [25] Matrix_1.2-18         fastmap_1.0.1         lazyeval_0.2.2       
##  [28] limma_3.46.0          later_1.1.0.1         formatR_1.7          
##  [31] admisc_0.11           htmltools_0.5.0       tools_4.0.3          
##  [34] rsvd_1.0.3            igraph_1.2.6          gtable_0.3.0         
##  [37] glue_1.4.2            RANN_2.6.1            reshape2_1.4.4       
##  [40] Rcpp_1.0.5            spatstat_1.64-1       vctrs_0.3.5          
##  [43] nlme_3.1-150          lmtest_0.9-38         xfun_0.19            
##  [46] stringr_1.4.0         globals_0.14.0        mime_0.9             
##  [49] miniUI_0.1.1.1        lifecycle_0.2.0       irlba_2.3.3          
##  [52] goftest_1.2-2         future_1.20.1         MASS_7.3-53          
##  [55] zoo_1.8-8             scales_1.1.1          promises_1.1.1       
##  [58] spatstat.utils_1.17-0 parallel_4.0.3        RColorBrewer_1.1-2   
##  [61] yaml_2.2.1            reticulate_1.18       pbapply_1.4-3        
##  [64] gridExtra_2.3         rpart_4.1-15          stringi_1.5.3        
##  [67] rlang_0.4.8           pkgconfig_2.0.3       matrixStats_0.57.0   
##  [70] evaluate_0.14         lattice_0.20-41       ROCR_1.0-11          
##  [73] purrr_0.3.4           tensor_1.5            patchwork_1.1.0      
##  [76] htmlwidgets_1.5.2     labeling_0.4.2        tidyselect_1.1.0     
##  [79] parallelly_1.21.0     RcppAnnoy_0.0.17      plyr_1.8.6           
##  [82] magrittr_2.0.1        R6_2.5.0              generics_0.1.0       
##  [85] pillar_1.4.7          withr_2.3.0           mgcv_1.8-33          
##  [88] fitdistrplus_1.1-1    survival_3.2-7        abind_1.4-5          
##  [91] tibble_3.0.4          future.apply_1.6.0    crayon_1.3.4         
##  [94] KernSmooth_2.23-18    plotly_4.9.2.1        rmarkdown_2.5        
##  [97] grid_4.0.3            data.table_1.13.2     digest_0.6.27        
## [100] xtable_1.8-4          tidyr_1.1.2           httpuv_1.5.4         
## [103] munsell_0.5.0         viridisLite_0.3.0
```



















