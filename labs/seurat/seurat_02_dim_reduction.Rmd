---
title: "Dimensionality reduction"
#CSS_ALL:
---

#DIMRED_TITLE:

#DIMRED_ALL1:

```{r, message='hide',warning='hide',results='hold'}
suppressMessages(require(scater))
suppressMessages(require(scran))
suppressMessages(require(ggplot2))

alldata <- readRDS("data/3pbmc_qc.rds")
```

#DIMRED_ALL1.1:

#DIMRED_ALL2:

```{r, message='hide',warning='hide',results='hold'}



alldata <- FindVariableFeatures(alldata, selection.method = "vst", nfeatures = 2000,verbose = FALSE,assay = "RNA")
top10 <- head(VariableFeatures(alldata), 10)

LabelPoints(plot = VariableFeaturePlot(alldata), points = top10, repel = TRUE)
```

#DIMRED_ALL3:

#DIMRED_ALL4:

```{r, message='hide',warning='hide',results='hold'}
alldata <- ScaleData(alldata, vars.to.regress = "percent_mito", assay = "RNA")
```


***
#PCA_TITLE:

#PCA_ALL1:

```{r, message='hide',warning='hide',results='hold'}
alldata <- RunPCA(alldata, npcs = 50, reduction.name = "PCA_on_RNA", assay = "RNA")
```

#PCA_ALL2:

```{r, message='hide',warning='hide',results='hold',fig.asp=.28,fig.width=16}
plot_grid(ncol = 3,
  DimPlot(alldata, reduction = "PCA_on_RNA", group.by = "orig.ident",dims = 1:2),
  DimPlot(alldata, reduction = "PCA_on_RNA", group.by = "orig.ident",dims = 3:4),
  DimPlot(alldata, reduction = "PCA_on_RNA", group.by = "orig.ident",dims = 5:6) )
```

#PCA_ALL3:

```{r,message='hide',warning='hide', results='hold',results='hold',fig.asp=.4,fig.width=12}
VizDimLoadings(alldata, dims = 1:4, reduction = "PCA_on_RNA",ncol = 4,balanced = T)
```

#PCA_ALL4:

```{r,message='hide',warning='hide', results='hold',results='hold',fig.asp=.3,fig.width=12}
DimHeatmap(alldata, dims = 1:3, cells = 100, balanced = TRUE,reduction = "PCA_on_RNA", ncol = 5)
```

#PCA_ALL5:

```{r,message='hide',warning='hide', results='hold',results='hold',fig.asp=.7,fig.width=4}
ElbowPlot(alldata, reduction = "PCA_on_RNA",ndims = 50)
```

#PCA_ALL6:

***
#tSNE_TITLE:

#tSNE_ALL1:

```{r,message='hide',warning='hide', results='hold',results='hold',fig.asp=1,fig.width=5}
alldata <- RunTSNE(alldata, reduction = "PCA_on_RNA", dims = 1:30, reduction.name = "TSNE_on_RNA",
                   perplexity=30,
                   max_iter=1000,
                   theta=0.5,
                   eta=200,
                   num_threads=0 )
#see ?Rtsne and ?RunTSNE for more info
```

#tSNE_ALL2:

```{r,message='hide',warning='hide', results='hold',results='hold',fig.asp=.28,fig.width=16}
plot_grid(ncol = 3,DimPlot(alldata, reduction = "TSNE_on_RNA", group.by = "orig.ident"))
```


***
#UMAP_TITLE:

#UMAP_ALL1:

```{r,message='hide',warning='hide', results='hold',results='hold',fig.asp=1.2,fig.width=10}
alldata <- RunUMAP(alldata, reduction = "PCA_on_RNA", dims = 1:30,reduction.name = "UMAP_on_RNA",
                   n.components=2,
                   n.neighbors=30,
                   n.epochs=200,
                   min.dist=0.3,
                   learning.rate=1,
                   spread=1 )
#see ?RunUMAP for more info
```

#UMAP_ALL2:

```{r,message='hide',warning='hide', results='hold',results='hold',fig.asp=.28,fig.width=16}
plot_grid(ncol = 3,DimPlot(alldata, reduction = "UMAP_on_RNA", group.by = "orig.ident"))
```

***
#DIMRED_TITLE2:

#DIMRED_ALL5:

```{r,message='hide',warning='hide', results='hold',results='hold',fig.asp=.28,fig.width=16}
plot_grid(ncol = 3,
  DimPlot(alldata, reduction = "PCA_on_RNA", group.by = "orig.ident"),
  DimPlot(alldata, reduction = "TSNE_on_RNA", group.by = "orig.ident"),
  DimPlot(alldata, reduction = "UMAP_on_RNA", group.by = "orig.ident")
)
```

#DIMRED_ALL6:

#MARKER_TABLE:

```{r,message='hide',warning='hide', results='hold',results='hold',fig.asp=.65,fig.width=16}
FeaturePlot(alldata, reduction = "UMAP_on_RNA",dims = 1:2,features = c("CD3E","CD4","CD8A","NKG7","GNLY","MS4A1","CD14","LYZ","MS4A7","FCGR3A","CST3","FCER1A"),ncol = 4,order = T)
```


#DIMRED_ALL7:

```{r,message='hide',warning='hide', results='hold',results='hold',fig.height=5,fig.width=16}
saveRDS(alldata,"data/3pbmc_qc_dm.rds")
```






